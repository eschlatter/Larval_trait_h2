---
title: "Amphiprion percula Larval Trait Heritability"
author: "E Schlatter"
date: "12/18/2021"
output: html_document
---

```{r}
library(tidyverse)
library(MasterBayes) #for pedigree functions
library(MCMCglmm)
library(MCMCpack) #for inverse wishart distributions
library(extraDistr) #for inverse gamma distribution (plotting priors)
```


##Read in and process the data.

Creates the following objects we'll use going forward:

$\textbf{phens}$: a list of each larva and its swimming speed and clutch, plus other covariates to be added. (Each parent also has a row in this list, to be compatible with relatedness matrix, but its swimming speed and covariates are all NA.)

$\textbf{Ainv}$: the inverse of the relatedness matrix, A. In A, $A_{ij}=$probability of identity by descent of an allele in individuals i and j.
```{r data cleanup}
#swim trial data
larvae <- as.data.frame(read.csv('data/Larvae.csv',header=TRUE)) %>%
  mutate(larvalID=Clutch+.01*Larva) #create unique identifier for each larva

#clutch data
metadata <- as.data.frame(read.csv('data/metadata.csv',header=TRUE))
colnames(metadata)[1]='Clutch'

#length data
lengths <- as.data.frame(read.csv('data/Lengths.csv',header=TRUE)) %>%
  mutate(larvalID=Clutch+.01*Larva) %>% #create unique identifier for each larva
  dplyr::select(-Clutch,-Larva) %>%
  rename(Measurer=Initials) %>%
  rename(SL=Average.length) %>%
  mutate(SL=as.numeric(SL))  #this will give "NAs introduced by coercion" -- that's fine

for(i in 1:nrow(larvae)){ #remove SL measurements for dead larvae; they're not accurate
  larvae$SL[i]=ifelse(larvae$Dead.before.preservation.[i]==1,NA,larvae$SL[i])} 

#merge swim trial and length data
larvae <- merge(larvae,lengths,by='larvalID')

larvae <- larvae %>% mutate('Time'=Time.min.+(1/60)*Time.sec.) %>% #add a Time column
  subset(Clutch>4) %>% #first four clutches were practice, and we won't use them in the dataset
  mutate(Clutch=as.factor(Clutch)) %>%
  mutate(larvalID=as.factor(larvalID))

#merge the larvae and metadata data frames, so metadata info is associated with each larva
larvae <- merge(larvae,metadata,by='Clutch') %>%
  dplyr::select(larvalID,everything()) #move larvalID to first column

larvae <- larvae %>% subset(is.na(SL)==FALSE) %>% #remove larvae with no SL measurement
  subset(is.na(Time)==FALSE) %>% #remove larvae with no speed measurement
  mutate(speed=Time-2) #Ucrit is swim time minus 2cm/sec

#make sure all covariates are in the right format
larvae <- larvae %>%
  mutate(R1.ID.=as.factor(R1.ID.)) %>%
  mutate(R2.ID.=as.factor(R2.ID.)) %>%
  mutate(Date=as.Date(Date, "%d-%b-%y")) %>%
  mutate(PostSwitch=as.factor(PostSwitch)) %>%
  mutate(Parental.tank=as.factor(Parental.tank))
```
Trim the dataset to larvae with both maternal and paternal half-sibs. 581 larvae from 12 mothers and 12 fathers.
```{r trim data}
mothers_trim <- c(5,6,9,10,13,18,22,30,59,66,70,114) #mothers in the trimmed dataset
#error in original data entry: father #137 is sometimes written #131
fathers_trim <- c(38,96,97,98,103,108,111,115,137,156,165,171) #fathers in the trimmed dataset
metadata <- subset(metadata,R1.ID.%in%mothers_trim & R2.ID.%in%fathers_trim)
larvae <- subset(larvae,R1.ID.%in%mothers_trim & R2.ID.%in%fathers_trim)
```

Create:
  - pedigree (and full_pedig, including the parents)
  - Ainv
  - phens (animal, speed, length, covariates)

```{r}
#pedigree and Ainv -- we'll need this later for heritability analysis
pedigree <- dplyr::select(larvae,id=larvalID,dam=R1.ID.,sire=R2.ID.)

#pedigree utility functions to insert parents and correctly order, from MasterBayes.
full_pedig <- pedigree %>%
  insertPed() %>%
  orderPed()
Ainv <- MCMCglmm::inverseA(full_pedig)$Ainv

#phenotype data frame
phens <- dplyr::select(larvae,animal=larvalID,speed=speed, length=SL, clutch=Clutch, 
                       dam=R1.ID., sire=R2.ID., tank=Parental.tank, age=Age.at.hatch)
  #add empty rows to phens for parents
parents <- subset(full_pedig,is.na(dam)) %>%
  transmute(animal=id,speed=as.numeric(dam),length=as.numeric(dam),clutch=NA,
            dam=NA,sire=NA,tank=NA,age=1)
phens <- as.data.frame(phens)
phens <- rbind(parents,phens)
```


```{r}
#this needs parents' SL to work
#get rid of extraneous columns
# larvae_cov=dplyr::select(larvae,larvalID,SL,speed,Clutch,Date,R1.ID.,R2.ID.,
#                          Parental.tank,PostSwitch,Age.at.hatch,R1_SL,R2_SL,Notes)
```

## Animal model

### Priors
From Hadfield course notes (p.13):
"The inverse gamma is a special case of the inverse Wishart, although it is parametrised using shape and scale, where nu = 2$*$shape and V = scale/shape (or shape = nu/2 and scale = nu$*$V/2 ). MCMCpack provides a density function (dinvgamma) for the inverse gamma distribution."

"The distribution tends to a point mass on V as the degree of belief parameter, nu, goes to infinity." The mean is not define for nu<2.

Several priors to try:
```{r priors, results='hide'}

#parameter-expanded prior
prior_expand_params <- list(V = 1,nu = 1000, alpha.mu=0, alpha.V=1)

#also parameter-expanded, from tuto_en; with residual edited (nu=0.002 instead of nu=1) to be proper
prior_ext_params <- list(V=1,nu=1,alpha.mu=0,alpha.V=1000)

#inverse gamma prior
prior_invgamma_params <- list(V = 1,nu = .002)

#gentler inverse gamma prior
prior_invgamma2_params <- list(V = 1,nu = .02)

#flat prior
prior_flat_params <- list(V = 1e-10,nu = -1)
```


Plot them (when possible):
```{r}
#pick one
param_list <- prior_expand_params
nu <- param_list$nu
V <- param_list$V

#corresponding shape and scale (invgamma) parameters
shape=nu/2
scale=nu*V/2

xrange <- seq(0.0001,1,.0001)

ggplot()+
  geom_line(aes(x=xrange,y=MCMCpack::dinvgamma(xrange,shape,scale))) 




#structure for plugging in the params to generate a full prior -- this is what MCMCglmm takes

prior_structure <- list(R=list(V=1,nu=0.002),
                      G=list(G1=param_list,
                             G2=param_list))

```

```{r}
###scratch


#inverse gamma prior
prior_invgamma = list(R = list(V = 1, nu = 0.002),
             G = list(G1 = list(V = 1,nu = .002),
                      G2 = list(V = 1,nu = .002)))
#corresponding shape and scale parameters
sh_invgamma=0.002/2
sc_invgamma=0.002*1/2

distys <- data.frame(x=seq(0.001,1,0.001),y=NA,dist='invgamma')
for(i in 1:nrow(distys)){distys$y[i]=diwish(distys$x[i],1,0.002)}

y <- diwish(0.02,v=1,S=0.002)


#plot them
x <- seq(0,1,.001)

ggplot()+
  geom_line(aes(x=x, y=extraDistr::dinvgamma(x,alpha=0.001,beta=0.001)))+ #invgamma
  geom_line(aes(x=x, y=MCMCpack::dinvgamma(x,shape=0.001,scale=0.001))) #invgamma with new pkg
                   

#Store them in a list so they're easy to access later
#priors on the variances of each effect
#inverse Wishart distribution

priors_2effects=list(prior_expand,prior_ext,prior_invgamma,prior_invgamma2,prior_flat)

#another list for priors when the model has more random effects -- same prior for each effect
```






### SL:animal model
Model: y=a+c+e  (a=additive genetic effect; c=clutch; e=residual)



```{r}
#-------------------------------no animal model----------------------------------

prior_noanim=prior_invgamma2 = list(R = list(V = 1, nu = 0.002),
             G = list(G1 = list(V = 1,nu = .002),
                      G2 = list(V = 1,nu = .002),
                      G3 = list(V = 1,nu = .002)))


model_noanim=MCMCglmm(length ~ 1+age, random=~clutch+dam+sire,prior=prior_noanim,data=phens,nitt=100000,burnin=100,thin=10)
model=model_noanim


#--------------Gelman-Rubin diagnostic

start1=list(R=runif(1),G=c(runif(1),runif(1),runif(1)))
start2=list(R=runif(1),G=c(runif(1),runif(1),runif(1)))
model_noanim1=MCMCglmm(length ~ 1, random=~clutch+dam+sire,prior=prior_noanim,
                       data=phens,nitt=100000,burnin=100,thin=10,
                       start=start1)
model_noanim2=MCMCglmm(length ~ 1, random=~clutch+dam+sire,prior=prior_noanim,
                       data=phens,nitt=100000,burnin=100,thin=10,
                       start=start2)

intercept_gel=mcmc.list(model_noanim1$Sol,model_noanim2$Sol)
clutch_gel=mcmc.list(model_noanim1$VCV[,'clutch'],model_noanim2$VCV[,'clutch'])
dam_gel=mcmc.list(model_noanim1$VCV[,'dam'],model_noanim2$VCV[,'dam'])
sire_gel=mcmc.list(model_noanim1$VCV[,'sire'],model_noanim2$VCV[,'sire'])
units_gel=mcmc.list(model_noanim1$VCV[,'units'],model_noanim2$VCV[,'units'])

par(mfrow=c(3,2))
gelman.plot(intercept_gel)
gelman.plot(clutch_gel,main="clutch")
gelman.plot(dam_gel,main="dam")
gelman.plot(sire_gel,main="sire")
gelman.plot(units_gel,main="units")

#-----------------------------------------------

model=model_noanim

v_clutch = model$VCV[, "clutch"]/
  (model$VCV[,"clutch"] +model$VCV[,"dam"]+model$VCV[,"sire"] + model$VCV[, "units"])
v_dam = model$VCV[, "dam"]/
  (model$VCV[,"clutch"] +model$VCV[,"dam"]+model$VCV[,"sire"] + model$VCV[, "units"])
v_sire = model$VCV[, "sire"]/
  (model$VCV[,"clutch"] +model$VCV[,"dam"]+model$VCV[,"sire"] + model$VCV[, "units"])
v_units = model$VCV[, "units"]/
  (model$VCV[,"clutch"] +model$VCV[,"dam"]+model$VCV[,"sire"] + model$VCV[, "units"])

#--------------------nice plot of posteriors----------------

var_noanim=rbind(v_clutch,v_dam,v_sire,v_units)
var_noanim=t(var_noanim)
var_noanim=as.matrix(var_noanim)

mcmc_areas(var_noanim,prob=0.95,area_method='equal height')

#--------------------------------------------


#create a data frame with estimates of the proportion of variance due to each effect: clutch, dam, sire, units
variances=data.frame(mean=mean(v_clutch),lower95=HPDinterval(v_clutch)[1,1],upper95=HPDinterval(v_clutch)[1,2],sampsize=effectiveSize(v_clutch))
variances=add_row(variances,mean=mean(v_dam),lower95=HPDinterval(v_dam)[1,1],upper95=HPDinterval(v_dam)[1,2],sampsize=effectiveSize(v_dam))
variances=add_row(variances,mean=mean(v_sire),lower95=HPDinterval(v_sire)[1,1],upper95=HPDinterval(v_sire)[1,2],sampsize=effectiveSize(v_sire))
variances=add_row(variances,mean=mean(v_units),lower95=HPDinterval(v_units)[1,1],upper95=HPDinterval(v_units)[1,2],sampsize=effectiveSize(v_units))
rownames(variances)=c('clutch','dam','sire','units')

variances_noanim=variances


plot_noanim= ggplot(variances_noanim, aes(x=rownames(variances_noanim),y=mean,ymin=0,ymax=1))+
  geom_point()+
  geom_errorbar(aes(ymin=lower95,ymax=upper95),width=.3)+
  xlab('source of variance')+
  ylab('proportion of variance (mean+/- Bayesian 95%CI')+
  geom_point(aes(x=rownames(variances_noanim),y=frequentist_var_props,color='Frequentist estimate'),color='blue')

```