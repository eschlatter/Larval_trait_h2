---
title: "Heritability analysis update"
author: "E Schlatter"
date: "7/7/2022"
output: html_document
---

```{r, warning=FALSE, echo=FALSE, message=FALSE}
library(tidyverse)
library(MasterBayes) #for pedigree functions
library(MCMCglmm) #for running the model
library(MCMCpack) #for inverse wishart distributions
library(bayesplot) #mcmc_areas plot function
library(gridExtra) #multiple plots per figure
source("../functions/model_fns.R")
load("../model_runs/phens.RData")
load("../model_runs/NullEstVA_corrected.RData")
```

## Update on null expectation problem
The problem from last time, where randomly shuffled data was generating higher estimates of VA than the real data, was the result of a typo! The runs using the shuffled data were also not using relatedness data among individuals -- i.e., essentially assuming that no one was related to anyone else. When that problem is fixed, the results look like this:

```{r,echo=FALSE,warning=FALSE}
load("../model_runs/priorpostmods.RData")
SL_noparent_oldprior = mods[[1]]
SL_noparent_newprior = mods[[2]]
SL_noparent_smallprior = mods[[3]]
SL_noparent_shuffle = mods[[4]]

nu. = 0.02
V. = 1

#get summary stats to annotate usual prior vs posterior plot
modemin = min(summ_stats[,10])
modemax = max(summ_stats[,10])
modemean = mean(summ_stats[,10])

#usual prior vs posterior plot
model = SL_noparent_oldprior
xlim=0.04
xvals = seq(0,xlim,length.out=nrow(model$VCV))
prior_mode = xvals[which.max(dinvgamma(xvals,shape = nu./2,scale = nu.*V./2))]
animal_samples = as.data.frame(model$VCV)$animal
post_density = density(animal_samples)
post_mode = post_density$x[which.max(post_density$y)]
colors=c('Prior'='blue','Posterior'='red')

g <- ggplot(as.data.frame(model$VCV), aes(x=animal)) + 
  geom_density(aes(color='Posterior'))+
  geom_line(aes(x = seq(0,xlim,length.out=nrow(model$VCV)), 
                y = dinvgamma(xvals,shape = nu./2,scale = nu.*V./2),
                color='Prior'))+
  geom_vline(aes(xintercept = prior_mode, color='Prior'))+
  geom_vline(aes(xintercept = post_mode, color='Posterior'))+
  labs(color='Legend')+
  ylab('density')+
  scale_color_manual(values=colors)+
  ggtitle(paste('V=',V.,' nu=',nu.))+
  annotate('text', x=c(prior_mode,post_mode),y=c(10,20),label=c(as.character(round(prior_mode,4)),as.character(round(post_mode,4))),colour = c('blue','red'))+
  annotate('segment', x=modemin,xend=modemax,y=100,yend=100,color='black',size=1.5)

print(g)
```


This is more like what I'd expect to see. The black bar (which is now very small) shows the range of posterior modes for VA estimated by randomly shuffling the phenotypes among individuals 100 times. The distribution in ____ represents the posterior estimate from the actual data. Even though the modes from the random runs are within the 5%-95% range of the real posterior estimate, the real posterior mode is not within the range of what we'd get by chance. I think, based on this, that we can say the estimate we've generated is different from the expectation under a random assignment of phenotypes.

[I don't think we need to include this figure in the manuscript or supplement at all.]

## Estimates using updated priors

Following the suggestion of one reviewer, I've changed the priors a bit. We're estimating three variance components: additive genetic, clutch, and residual. (Or five -- add dam and sire -- in the model with parental effects.) Previously I'd used priors that were very flat, with their mode close to zero. The reviewer suggested trying modes equal to 1/3 (or 1/5) of the total phenotypic variance: i.e., a null hypothesis that all components contribute equally to the phenotypic variance, rather than that all components contribute nothing.

That makes me realize that a more appropriate choice of prior than our original one would be to have the modes close to zero for all components except the residual variance, which should have a mode equal to the observed phenotypic variance. That corresponds to the null hypothesis that all variation is residual -- i.e., none of it can be accounted for by our predictor variables.

### Ucrit

#### [clutch and animal = 0, residual = p_var]
Doesn't mix well at all
```{r}
nu = 0.001
p_var = var(phens$speed,na.rm=TRUE) #total phenotypic variance
p_A = p_var * 0.01 #prior mode for additive genetic effect
V_A = ((nu+2)/nu)*p_A #prior parameter V (inverse Wishart) for additive genetic effect
p_C = p_var * 0.01
V_C = ((nu+2)/nu)*p_C
p_E = p_var * 0.98
V_E = ((nu+2)/nu)*p_E


#prior = list(R=list(V=V_E,nu=nu),G=list(G1=list(V=V_A,nu=nu),G2=list(V=V_C,nu=nu)))
prior = list(R=list(V=V_E,nu=nu),G=list(G1=list(V=1,nu=1,alpha.mu=0,alpha.V=1000),G2=list(V=V_C,nu=nu)))
model <- MCMCglmm(speed~1+age,
                    random=~animal+clutch,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)
save(model,file='../model_runs/priors_and_posts/Ucrit_noparent_1.RData') #nitt = 1 000 000
load(file='../model_runs/priors_and_posts/Ucrit_noparent_1.RData')

model_diagnostics(model)
model_results(model)
```

#### [same thing, but parameter expansion for animal]
Much better! And VA=0.
```{r}
nu = 0.001
p_var = var(phens$speed,na.rm=TRUE) #total phenotypic variance
p_C = p_var * 0.01
V_C = ((nu+2)/nu)*p_C
p_E = p_var * 0.98
V_E = ((nu+2)/nu)*p_E


prior = list(R=list(V=V_E,nu=nu),G=list(G1=list(V=1,nu=1,alpha.mu=0,alpha.V=1000),G2=list(V=V_C,nu=nu)))
model <- MCMCglmm(speed~1+age,
                    random=~animal+clutch,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)

model_diagnostics(model)
model_results(model)
```

#### [equal distribution of variances
Mixes better (not great), but a very different result than we had in the paper!
```{r}
nu = 0.001
p_var = var(phens$speed,na.rm=TRUE) #total phenotypic variance
p_A = p_var/3 #prior mode for additive genetic effect
V_A = ((nu+2)/nu)*p_A #prior parameter V (inverse Wishart) for additive genetic effect
p_C = p_var/3
V_C = ((nu+2)/nu)*p_C
p_E = p_var/3
V_E = ((nu+2)/nu)*p_E


prior = list(R=list(V=V_E,nu=nu),G=list(G1=list(V=V_A,nu=nu),G2=list(V=V_C,nu=nu)))
model <- MCMCglmm(speed~1+age,
                    random=~animal+clutch,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)

model_diagnostics(model)
model_results(model)
```

### SL

#### [clutch and animal = 0, residual = p_var]
Doesn't mix well. (What if we just run it for a really long time? Mixing improves, get a bimodal posterior.)
```{r}
nu = 0.001
p_var = var(phens$length,na.rm=TRUE) #total phenotypic variance
p_A = p_var * 0.01 #prior mode for additive genetic effect
V_A = ((nu+2)/nu)*p_A #prior parameter V (inverse Wishart) for additive genetic effect
p_C = p_var * 0.01
V_C = ((nu+2)/nu)*p_C
p_E = p_var * 0.98
V_E = ((nu+2)/nu)*p_E


prior = list(R=list(V=V_E,nu=nu),G=list(G1=list(V=V_A,nu=nu),G2=list(V=V_C,nu=nu)))
model <- MCMCglmm(length~1+age,
                    random=~animal+clutch,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=1000000,burnin=round(.01*1000000),thin=100,verbose=FALSE)

model_diagnostics(model)
model_results(model)
plot_priorandpost_new(model,nu,V_A,V_C,V_E,xlim=0.02)
```
```{r}
# parameter-expansion parameters --> F distribution:
# https://pdfs.semanticscholar.org/488d/4dd459fe05da4f0443a62be3dafd342ba9d6.pdf

# plot example
# https://people.bath.ac.uk/jjf23/mixchange/onewayanova.html#parameter-expansion
x <- (1:300)/100
alpha.V <- 1000
alpha.mu <- 0
nu <- 1
plot(x,df(x/alpha.V, df1 = 1, df2 = nu, ncp = (alpha.mu^2)/alpha.V),type="l",ylab="Density")
```


#### [same thing, but parameter expansion for animal]
Mixes much better, but hmmm.
The priors should be pulling VA to zero (because VE is centered on VP). But we see a lot of mass in VA (and h2) away from zero. That indicates to me that the data are pulling the posterior VA away from zero. But the result is kind of ugly, with the bimodal posterior. Can we fix that?
```{r}
nu = 0.001
p_var = var(phens$length,na.rm=TRUE) #total phenotypic variance
p_C = p_var * 0.01
V_C = ((nu+2)/nu)*p_C
p_E = p_var * 0.98
V_E = ((nu+2)/nu)*p_E


prior = list(R=list(V=V_E,nu=nu),G=list(G1=list(V=1,nu=1000,alpha.mu=0,alpha.V=1),G2=list(V=V_C,nu=nu)))
model <- MCMCglmm(length~1+age,
                    random=~animal+clutch,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)
save(model,file='../model_runs/priors_and_posts/SL_noparent_2.RData')

load(file='../model_runs/priors_and_posts/SL_noparent_2.RData')

model_diagnostics(model)
model_results(model)
plot_priorandpost_new(model,nu,V_C,V_C,V_E,xlim=0.02)

plot_priorandpost_two(model,prior,xlim=0.1)

xvals = seq(0,0.4,length.out=9900)
V = 1
nu = 0.02
alpha.V = 1000
alpha.mu = 0
prior_density = df(xvals/alpha.V, df1 = 1, df2 = nu, ncp = (alpha.mu^2)/alpha.V)
plot(xvals,prior_density,type='l')
plot(xvals,prior_density,type='l',ylim=c(0,1))
```
Prove to myself that an inverse gamma (0.001,0.001) distribution does actually integrate to one:
```{r}
library(invgamma)
xvals = seq(0,5,length.out=100)

shape=1
scale=1
plot(xvals,dinvgamma(xvals,shape=shape,scale=scale),type='l')
shape=.01
scale=.01
lines(xvals,dinvgamma(xvals,shape=shape,scale=scale),type='l',lty='dashed')

dinvgamma(10,shape=1,scale=1)-dinvgamma(10,shape=.001,scale=0.001)
pinvgamma(3,shape=1,scale=1)
pinvgamma(10e300,shape=0.001,scale=0.001) #it does, but not for a ridiculously long time.
```


#### [parameter expansion for animal; residual = 80% of VP]
Try moving the prior for VE down just a little, so it's not pulling VA toward zero as harshly.
Result: similar, but the posterior for VA is maybe a little less lumpy
```{r}
nu = 0.001
p_var = var(phens$length,na.rm=TRUE) #total phenotypic variance
p_C = p_var * 0.01
V_C = ((nu+2)/nu)*p_C
p_E = p_var * 0.8
V_E = ((nu+2)/nu)*p_E


prior = list(R=list(V=V_E,nu=nu),G=list(G1=list(V=1,nu=1,alpha.mu=0,alpha.V=1000),G2=list(V=V_C,nu=nu)))
model <- MCMCglmm(length~1+age,
                    random=~animal+clutch,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)

model_diagnostics(model)
model_results(model)
plot_priorandpost_new(model,nu,V_C,V_C,V_E,xlim=0.02)
```
#### [nu = 0.0001]
Make the priors even flatter?

```{r}
nu = 0.0001
p_var = var(phens$length,na.rm=TRUE) #total phenotypic variance
p_C = p_var * 0.01
V_C = ((nu+2)/nu)*p_C
p_E = p_var * 0.98
V_E = ((nu+2)/nu)*p_E


prior = list(R=list(V=V_E,nu=nu),G=list(G1=list(V=1,nu=1,alpha.mu=0,alpha.V=1000),G2=list(V=V_C,nu=nu)))
model <- MCMCglmm(length~1+age,
                    random=~animal+clutch,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=500000,burnin=round(.01*500000),thin=50,verbose=FALSE)

model_diagnostics(model)
model_results(model)

plot_priorandpost_new(model,nu,V_C,V_C,V_E,xlim=0.02)

```

#### [All variance components = 0; param expansion for VA]
```{r}
nu = 0.001
p_var = var(phens$length,na.rm=TRUE) #total phenotypic variance
p_C = p_var * 0.01
V_C = ((nu+2)/nu)*p_C
p_E = p_var * 0.01
V_E = ((nu+2)/nu)*p_E


prior = list(R=list(V=V_E,nu=nu),G=list(G1=list(V=1,nu=1,alpha.mu=0,alpha.V=1000),G2=list(V=V_C,nu=nu)))
model <- MCMCglmm(length~1+age,
                    random=~animal+clutch,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)

model_diagnostics(model)
model_results(model)
```

#### [equal distribution of variances]
Mixes better (not great), looks like the result we have in the manuscript
```{r}
nu = 0.001
p_var = var(phens$length,na.rm=TRUE) #total phenotypic variance
p_A = p_var/3 #prior mode for additive genetic effect
V_A = ((nu+2)/nu)*p_A #prior parameter V (inverse Wishart) for additive genetic effect
p_C = p_var/3
V_C = ((nu+2)/nu)*p_C
p_E = p_var/3
V_E = ((nu+2)/nu)*p_E


prior = list(R=list(V=V_E,nu=nu),G=list(G1=list(V=V_A,nu=nu),G2=list(V=V_C,nu=nu)))
model <- MCMCglmm(length~1+age,
                    random=~animal+clutch,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)

model_diagnostics(model)
model_results(model)
```

## Prior sensitivity

### Ucrit, no parents
First, generate the model runs.

Total phenotypic variance in Ucrit is 4.58. We're estimating three components of variance: VA, VC, and VE. Each run will use a different set of prior distributions for VA, VC, and VE. All priors will be inverse gamma with nu = 0.001 (i.e., very flat), so they can be uniquely defined by the mode (peak).

- We'll keep the mode of the prior for VC the same for all runs: 0.65. (This is a good guess for the actual value, based on previous tries.)
- For each run, choose the prior mode of VA from a sequence running from 0 to the total phenotypic variance (minus the VC mode).
- Then define the prior mode of VE so that the three prior modes add up to the total phenotypic variance.

E.g., run 1: VC mode = 0.65. VA mode = 0.05. So VE mode = 4.58 - 0.65 - 0.05 = 3.88.
```{r,eval=FALSE}
p_var = var(phens$speed,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
nu = 0.001

#set prior mode for clutch at reasonable estimate of 0.65; stays the same for all of these model runs
p_C = 0.65
V_C = ((nu+2)/nu)*0.65

# Run model for range of priors and store results
VA_samples = data.frame(matrix(ncol=10,nrow=0))
VC_samples = data.frame(matrix(ncol=10,nrow=0))
VE_samples = data.frame(matrix(ncol=10,nrow=0))

for(p in prior_modes){
  V_A = ((nu+2)/nu)*p
  p_E = p_var - p - p_C
  V_E = ((nu+2)/nu)*p_E
  
  prior = list(R=list(V=V_E,nu=0.001),G=list(G1=list(V=V_A,nu=0.001),G2=list(V=V_C,nu=0.001)))
  model <- MCMCglmm(speed~1+age,
                    random=~animal+clutch,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)
  v_mcmc <- model$VCV
  effSamp=effectiveSize(v_mcmc)

  #VA
  animal_samples = as.data.frame(model$VCV)$animal
  quants = quantile(animal_samples,c(0.05,0.25,0.5,0.75,0.95))
  post_density = density(animal_samples)
  post_mode = post_density$x[which.max(post_density$y)]
  effSampA = as.data.frame(t(effSamp))$animal
  newrow=c(p,p_E,p_C,effSampA,post_mode,as.numeric(quants))
  VA_samples = rbind(VA_samples,newrow)

  #VC
  clutch_samples = as.data.frame(model$VCV)$clutch
  quants = quantile(clutch_samples,c(0.05,0.25,0.5,0.75,0.95))
  post_density = density(clutch_samples)
  post_mode = post_density$x[which.max(post_density$y)]
  effSampC = as.data.frame(t(effSamp))$clutch
  newrow=c(p,p_E,p_C,effSampC,post_mode,as.numeric(quants))
  VC_samples = rbind(VC_samples,newrow)

  #VE
  units_samples = as.data.frame(model$VCV)$units
  quants = quantile(units_samples,c(0.05,0.25,0.5,0.75,0.95))
  post_density = density(units_samples)
  post_mode = post_density$x[which.max(post_density$y)]
  effSampE = as.data.frame(t(effSamp))$units
  newrow=c(p,p_E,p_C,effSampE,post_mode,as.numeric(quants))
  VE_samples = rbind(VE_samples,newrow)

  #save model run for further use
  save(model,file=paste0('../model_runs/prior_sensitivity/Again/Ucrit_noparent_p=',round(p,3),'.RData'))
  print(p)
}

colnames(VA_samples)=c('prior_mode_A','prior_mode_E','prior_mode_C','effSampVA','post_mode','q5','q25','q50','q75','q95')
colnames(VC_samples)=c('prior_mode_A','prior_mode_E','prior_mode_C','effSampVC','post_mode','q5','q25','q50','q75','q95')
colnames(VE_samples)=c('prior_mode_A','prior_mode_E','prior_mode_C','effSampVE','post_mode','q5','q25','q50','q75','q95')

save(VA_samples,file='../model_runs/prior_sensitivity/Again/Ucrit_noparent_VA.RData')
save(VC_samples,file='../model_runs/prior_sensitivity/Again/Ucrit_noparent_VC.RData')
save(VE_samples,file='../model_runs/prior_sensitivity/Again/Ucrit_noparent_VE.RData')
```

```{r}
p_var = var(phens$speed,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
herit_samples = data.frame()

for(p in prior_modes){
  load(file=paste0('../model_runs/prior_sensitivity/Again/Ucrit_noparent_p=',round(p,3),'.RData'))
  herit <- model$VCV[,1]/rowSums(as.data.frame(model$VCV)) #store them in a list
  v_estimates <- data.frame(prior_mode_A = p, effSamph2 = effectiveSize(herit), post_modeh2 = posterior.mode(herit),
                            upper95h2=HPDinterval(herit)[,2],lower95h2=HPDinterval(herit)[,1])
  herit_samples=rbind(herit_samples,v_estimates)
}

ggplot(data=herit_samples,aes(x=prior_mode_A,y=post_modeh2))+
    geom_point()+
    geom_line()+
    geom_errorbar(aes(ymin=lower95h2,ymax=upper95h2))
```

Plot priors vs posteriors.
Black points (modes) and intervals (5%-95% regions) are posterior estimates of VA, with prior mode indicated by x-axis value.
Blue points (modes) and intervals (5%-95% regions) are posterior estimates of VE, with prior mode chosen so the prior modes of VA, VE, and VC add up to the total phenotypic variance.
Black diagonal line is 1-1.
Purple vertical line is the prior value we actually used.
Red line is (scaled) effective sample size for VA (an indication of how well the MCMC algorithm worked).
```{r}
p_var = var(phens$speed,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
nu = 0.001

load(file='../model_runs/prior_sensitivity/Again/Ucrit_noparent_VA.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_noparent_VC.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_noparent_VE.RData')

ggplot(data=VA_samples,aes(x=prior_mode_A,y=post_mode))+
  geom_point()+
  geom_line()+
  xlab('Prior Mode of VA')+
  ylab('Posterior Mode and 5%-95% range')+
  ggtitle('Prior vs posterior modes, VA (black) and VE (blue) of Ucrit')+
  geom_errorbar(aes(ymin=q5, ymax=q95),width=0.025)+
  geom_point(data=VE_samples,aes(x=prior_mode_A+.025,y=post_mode),color='blue')+
  geom_line(data=VE_samples,aes(x=prior_mode_A+.025,y=post_mode),color='blue')+
  geom_errorbar(data=VE_samples,aes(x=prior_mode_A+.025,ymin=q5, ymax=q95),color='blue',width=0.025)+
  geom_abline(slope=1,intercept=0)+
  geom_vline(xintercept=p_var/3,color='purple')+
  geom_line(data=VA_samples,aes(x=prior_mode_A,y=effSampVA*(4/700)),color='red')

```



Plot example priors and posteriors for a single run
```{r}
load(file='../model_runs/prior_sensitivity/Again/Ucrit_noparent_VA.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_noparent_VC.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_noparent_VE.RData')


i = 16 #plot the model in the ith row of the samples tables

load(file=paste0('../model_runs/prior_sensitivity/Again/Ucrit_noparent_p=',round(prior_modes[i],3),'.RData'))
V_A = VA_samples$prior_mode_A[i]*(nu+2)/nu
V_C = VA_samples$prior_mode_C[i]*(nu+2)/nu
V_E = VA_samples$prior_mode_E[i]*(nu+2)/nu
plot_priorandpost_new(model,nu.=nu,V_A=V_A,V_C=V_C,V_E=V_E,xlim=p_var)
```



### Ucrit, with parents
First, generate the model runs.

Total phenotypic variance in Ucrit is 4.58. We're estimating five components of variance: VA, VC, VD, VS, and VE. Each run will use a different set of prior distributions for the variance components. All priors will be inverse gamma with nu = 0.001 (i.e., very flat), so they can be uniquely defined by the mode (peak).

- We'll keep the mode of the prior for VC the same for all runs: 0.65. (This is a good guess for the actual value, based on previous tries.)
- Set VD and VS prior modes to 0.65 also. This is probably a little high.
- For each run, choose the prior mode of VA from a sequence running from 0 to the total phenotypic variance (minus the VC, VD, and VS modes).
- Then define the prior mode of VE so that the five prior modes add up to the total phenotypic variance.

[Checked with other values for VC, VD, and VS prior modes: all 0.25 or all 1. Increasing prior mode increases estimate of each of these variance components, which decreases estimate of VA and doesn't affect estimate of VE. This is pretty much what we'd expect.]
Second run: same thing, but VC, VD and VS prior modes are all 0.25.
Third run: same thing, but VC, VD and VS prior modes are all 1.
```{r,eval=FALSE,echo=FALSE}
p_var = var(phens$speed,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
nu = 0.001

#set prior modes for clutch and parents at reasonable-to-high estimate of 0.65; stays the same for all of these model runs
p_C = 0.65
V_C = ((nu+2)/nu)*p_C
p_D = 0.65
V_D = ((nu+2)/nu)*p_D
p_S = 0.65
V_S = ((nu+2)/nu)*p_S

# Run model for range of priors and store results
VA_samples = data.frame(matrix(ncol=10,nrow=0))
VC_samples = data.frame(matrix(ncol=10,nrow=0))
VD_samples = data.frame(matrix(ncol=10,nrow=0))
VS_samples = data.frame(matrix(ncol=10,nrow=0))
VE_samples = data.frame(matrix(ncol=10,nrow=0))

for(p in prior_modes){
  V_A = ((nu+2)/nu)*p
  p_E = p_var - p - (p_C+p_D+p_S)
  V_E = ((nu+2)/nu)*p_E
  
  prior = list(R=list(V=V_E,nu=0.001),G=list(G1=list(V=V_A,nu=0.001),G2=list(V=V_C,nu=0.001),G3=list(V=V_D,nu=0.001),G4=list(V=V_S,nu=0.001)))
  model <- MCMCglmm(speed~1+age,
                    random=~animal+clutch+dam+sire,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)
  v_mcmc <- model$VCV
  effSamp=effectiveSize(v_mcmc)

  #VA
  animal_samples = as.data.frame(model$VCV)$animal
  quants = quantile(animal_samples,c(0.05,0.25,0.5,0.75,0.95))
  post_density = density(animal_samples)
  post_mode = post_density$x[which.max(post_density$y)]
  effSampA = as.data.frame(t(effSamp))$animal
  newrow=c(p,p_E,p_C,effSampA,post_mode,as.numeric(quants))
  VA_samples = rbind(VA_samples,newrow)

  #VC
  clutch_samples = as.data.frame(model$VCV)$clutch
  quants = quantile(clutch_samples,c(0.05,0.25,0.5,0.75,0.95))
  post_density = density(clutch_samples)
  post_mode = post_density$x[which.max(post_density$y)]
  effSampC = as.data.frame(t(effSamp))$clutch
  newrow=c(p,p_E,p_C,effSampC,post_mode,as.numeric(quants))
  VC_samples = rbind(VC_samples,newrow)
  
  #VD
  dam_samples = as.data.frame(model$VCV)$dam
  quants = quantile(dam_samples,c(0.05,0.25,0.5,0.75,0.95))
  post_density = density(dam_samples)
  post_mode = post_density$x[which.max(post_density$y)]
  effSampD = as.data.frame(t(effSamp))$dam
  newrow=c(p,p_E,p_C,effSampD,post_mode,as.numeric(quants))
  VD_samples = rbind(VD_samples,newrow)
  
  #VS
  sire_samples = as.data.frame(model$VCV)$sire
  quants = quantile(sire_samples,c(0.05,0.25,0.5,0.75,0.95))
  post_density = density(sire_samples)
  post_mode = post_density$x[which.max(post_density$y)]
  effSampS = as.data.frame(t(effSamp))$sire
  newrow=c(p,p_E,p_C,effSampS,post_mode,as.numeric(quants))
  VS_samples = rbind(VS_samples,newrow)

  #VE
  units_samples = as.data.frame(model$VCV)$units
  quants = quantile(units_samples,c(0.05,0.25,0.5,0.75,0.95))
  post_density = density(units_samples)
  post_mode = post_density$x[which.max(post_density$y)]
  effSampE = as.data.frame(t(effSamp))$units
  newrow=c(p,p_E,p_C,effSampE,post_mode,as.numeric(quants))
  VE_samples = rbind(VE_samples,newrow)

  #save model run for further use
  save(model,file=paste0('../model_runs/prior_sensitivity/Again/Ucrit_withparent_p=',round(p,3),'.RData'))
  print(p)
}

colnames(VA_samples)=c('prior_mode_A','prior_mode_E','prior_mode_C','effSampVA','post_mode','q5','q25','q50','q75','q95')
colnames(VC_samples)=c('prior_mode_A','prior_mode_E','prior_mode_C','effSampVC','post_mode','q5','q25','q50','q75','q95')
colnames(VD_samples)=c('prior_mode_A','prior_mode_E','prior_mode_C','effSampVD','post_mode','q5','q25','q50','q75','q95')
colnames(VS_samples)=c('prior_mode_A','prior_mode_E','prior_mode_C','effSampVS','post_mode','q5','q25','q50','q75','q95')
colnames(VE_samples)=c('prior_mode_A','prior_mode_E','prior_mode_C','effSampVE','post_mode','q5','q25','q50','q75','q95')

save(VA_samples,file='../model_runs/prior_sensitivity/Again/Ucrit_withparent_VA.RData')
save(VC_samples,file='../model_runs/prior_sensitivity/Again/Ucrit_withparent_VC.RData')
save(VD_samples,file='../model_runs/prior_sensitivity/Again/Ucrit_withparent_VD.RData')
save(VS_samples,file='../model_runs/prior_sensitivity/Again/Ucrit_withparent_VS.RData')
save(VE_samples,file='../model_runs/prior_sensitivity/Again/Ucrit_withparent_VE.RData')
```

Plot priors vs posteriors.
Black points (modes) and intervals (5%-95% regions) are posterior estimates of VA, with prior mode indicated by x-axis value.
Blue points (modes) and intervals (5%-95% regions) are posterior estimates of VE, with prior mode chosen so the prior modes of VA, VE, and VC add up to the total phenotypic variance.
Black diagonal line is 1-1.
Purple vertical line is the prior value we actually used.
Red line is (scaled) effective sample size for VA (an indication of how well the MCMC algorithm worked).
```{r,echo=FALSE}
p_var = var(phens$speed,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
nu = 0.001

load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent_VA.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent_VC.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent_VD.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent_VS.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent_VE.RData')

ggplot(data=VA_samples,aes(x=prior_mode_A,y=post_mode))+
  geom_point()+
  geom_line()+
  xlab('Prior Mode of VA')+
  ylab('Posterior Mode and 5%-95% range')+
  ggtitle('Prior vs posterior modes, VA (black) and VE (blue) of Ucrit [Model with parental effects]')+
  geom_errorbar(aes(ymin=q5, ymax=q95),width=0.025)+
  geom_point(data=VC_samples,aes(x=prior_mode_A+.01,y=post_mode),color='purple')+
  geom_line(data=VC_samples,aes(x=prior_mode_A+.01,y=post_mode),color='purple')+
  geom_errorbar(data=VC_samples,aes(x=prior_mode_A+.01,ymin=q5, ymax=q95),color='purple',width=0.025)+
  geom_point(data=VD_samples,aes(x=prior_mode_A+.015,y=post_mode),color='green')+
  geom_line(data=VD_samples,aes(x=prior_mode_A+.015,y=post_mode),color='green')+
  geom_errorbar(data=VD_samples,aes(x=prior_mode_A+.015,ymin=q5, ymax=q95),color='green',width=0.025)+
  geom_point(data=VS_samples,aes(x=prior_mode_A+.02,y=post_mode),color='orange')+
  geom_line(data=VS_samples,aes(x=prior_mode_A+.02,y=post_mode),color='orange')+
  geom_errorbar(data=VS_samples,aes(x=prior_mode_A+.02,ymin=q5, ymax=q95),color='orange',width=0.025)+
  geom_point(data=VE_samples,aes(x=prior_mode_A+.025,y=post_mode),color='blue')+
  geom_line(data=VE_samples,aes(x=prior_mode_A+.025,y=post_mode),color='blue')+
  geom_errorbar(data=VE_samples,aes(x=prior_mode_A+.025,ymin=q5, ymax=q95),color='blue',width=0.025)+
  geom_abline(slope=1,intercept=0,lty='dashed')+
  geom_vline(xintercept=p_var/3,color='purple')+
  geom_line(data=VA_samples,aes(x=prior_mode_A,y=effSampVA*(4/700)),color='red')
```

```{r}
p_var = var(phens$speed,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
herit_samples = data.frame()

for(p in prior_modes){
  load(file=paste0('../model_runs/prior_sensitivity/Again/Ucrit_withparent_p=',round(p,3),'.RData'))
  herit <- model$VCV[,1]/rowSums(as.data.frame(model$VCV)) #store them in a list
  v_estimates <- data.frame(prior_mode_A = p, effSamph2 = effectiveSize(herit), post_modeh2 = posterior.mode(herit),
                            upper95h2=HPDinterval(herit)[,2],lower95h2=HPDinterval(herit)[,1])
  herit_samples=rbind(herit_samples,v_estimates)
}

ggplot(data=herit_samples,aes(x=prior_mode_A,y=post_modeh2))+
    geom_point()+
    geom_line()+
    geom_errorbar(aes(ymin=lower95h2,ymax=upper95h2))
```

```{r,echo=FALSE,eval=FALSE}
p_var = var(phens$speed,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
nu = 0.001

load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent2_VA.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent2_VC.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent2_VD.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent2_VS.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent2_VE.RData')

ggplot(data=VA_samples,aes(x=prior_mode_A,y=post_mode))+
  geom_point()+
  geom_line()+
  xlab('Prior Mode of VA')+
  ylab('Posterior Mode and 5%-95% range')+
  ggtitle('Prior vs posterior modes, VA (black) and VE (blue) of Ucrit [Model with parental effects]')+
  geom_errorbar(aes(ymin=q5, ymax=q95),width=0.025)+
  geom_point(data=VC_samples,aes(x=prior_mode_A+.01,y=post_mode),color='purple')+
  geom_line(data=VC_samples,aes(x=prior_mode_A+.01,y=post_mode),color='purple')+
  geom_errorbar(data=VC_samples,aes(x=prior_mode_A+.01,ymin=q5, ymax=q95),color='purple',width=0.025)+
  geom_point(data=VD_samples,aes(x=prior_mode_A+.015,y=post_mode),color='green')+
  geom_line(data=VD_samples,aes(x=prior_mode_A+.015,y=post_mode),color='green')+
  geom_errorbar(data=VD_samples,aes(x=prior_mode_A+.015,ymin=q5, ymax=q95),color='green',width=0.025)+
  geom_point(data=VS_samples,aes(x=prior_mode_A+.02,y=post_mode),color='orange')+
  geom_line(data=VS_samples,aes(x=prior_mode_A+.02,y=post_mode),color='orange')+
  geom_errorbar(data=VS_samples,aes(x=prior_mode_A+.02,ymin=q5, ymax=q95),color='orange',width=0.025)+
  geom_point(data=VE_samples,aes(x=prior_mode_A+.025,y=post_mode),color='blue')+
  geom_line(data=VE_samples,aes(x=prior_mode_A+.025,y=post_mode),color='blue')+
  geom_errorbar(data=VE_samples,aes(x=prior_mode_A+.025,ymin=q5, ymax=q95),color='blue',width=0.025)+
  geom_abline(slope=1,intercept=0,lty='dashed')+
  geom_vline(xintercept=p_var/3,color='purple')+
  geom_line(data=VA_samples,aes(x=prior_mode_A,y=effSampVA*(4/700)),color='red')
```

```{r,echo=FALSE,eval=FALSE}
p_var = var(phens$speed,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
nu = 0.001

load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent3_VA.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent3_VC.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent3_VD.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent3_VS.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent3_VE.RData')

ggplot(data=VA_samples,aes(x=prior_mode_A,y=post_mode))+
  geom_point()+
  geom_line()+
  xlab('Prior Mode of VA')+
  ylab('Posterior Mode and 5%-95% range')+
  ggtitle('Prior vs posterior modes, VA (black) and VE (blue) of Ucrit [Model with parental effects]')+
  geom_errorbar(aes(ymin=q5, ymax=q95),width=0.025)+
  geom_point(data=VC_samples,aes(x=prior_mode_A+.01,y=post_mode),color='purple')+
  geom_line(data=VC_samples,aes(x=prior_mode_A+.01,y=post_mode),color='purple')+
  geom_errorbar(data=VC_samples,aes(x=prior_mode_A+.01,ymin=q5, ymax=q95),color='purple',width=0.025)+
  geom_point(data=VD_samples,aes(x=prior_mode_A+.015,y=post_mode),color='green')+
  geom_line(data=VD_samples,aes(x=prior_mode_A+.015,y=post_mode),color='green')+
  geom_errorbar(data=VD_samples,aes(x=prior_mode_A+.015,ymin=q5, ymax=q95),color='green',width=0.025)+
  geom_point(data=VS_samples,aes(x=prior_mode_A+.02,y=post_mode),color='orange')+
  geom_line(data=VS_samples,aes(x=prior_mode_A+.02,y=post_mode),color='orange')+
  geom_errorbar(data=VS_samples,aes(x=prior_mode_A+.02,ymin=q5, ymax=q95),color='orange',width=0.025)+
  geom_point(data=VE_samples,aes(x=prior_mode_A+.025,y=post_mode),color='blue')+
  geom_line(data=VE_samples,aes(x=prior_mode_A+.025,y=post_mode),color='blue')+
  geom_errorbar(data=VE_samples,aes(x=prior_mode_A+.025,ymin=q5, ymax=q95),color='blue',width=0.025)+
  geom_abline(slope=1,intercept=0,lty='dashed')+
  geom_vline(xintercept=p_var/3,color='purple')+
  geom_line(data=VA_samples,aes(x=prior_mode_A,y=effSampVA*(4/700)),color='red')
```


Plot example priors and posteriors for a single run
```{r,eval=FALSE}
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent_VA.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent_VC.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent_VD.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent_VS.RData')
load(file='../model_runs/prior_sensitivity/Again/Ucrit_withparent_VE.RData')


i = 16 #plot the model in the ith row of the samples tables

load(file=paste0('../model_runs/prior_sensitivity/Again/Ucrit_noparent_p=',round(prior_modes[i],3),'.RData'))
V_A = VA_samples$prior_mode_A[i]*(nu+2)/nu
V_C = VA_samples$prior_mode_C[i]*(nu+2)/nu
V_E = VA_samples$prior_mode_E[i]*(nu+2)/nu
plot_priorandpost_new(model,nu.=nu,V_A=V_A,V_C=V_C,V_E=V_E,xlim=p_var)
```


### SL, no parents
First, generate the model runs.

Total phenotypic variance in SL is 0.015. We're estimating three components of variance: VA, VC, and VE. Each run will use a different set of prior distributions for VA, VC, and VE. All priors will be inverse gamma with nu = 0.001 (i.e., very flat), so they can be uniquely defined by the mode (peak).

- We'll keep the mode of the prior for VC the same for all runs: 0.0025. (This is a good guess for the actual value, based on previous tries.)
- For each run, choose the prior mode of VA from a sequence running from 0 to the total phenotypic variance (minus the VC mode).
- Then define the prior mode of VE so that the three prior modes add up to the total phenotypic variance.

```{r,eval=FALSE}
p_var = var(phens$length,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
nu = 0.001

#set prior mode for clutch at reasonable estimate of 0.65; stays the same for all of these model runs
p_C = 0.0025
V_C = ((nu+2)/nu)*0.0025

# Run model for range of priors and store results
VA_samples = data.frame(matrix(ncol=10,nrow=0))
VC_samples = data.frame(matrix(ncol=10,nrow=0))
VE_samples = data.frame(matrix(ncol=10,nrow=0))

for(p in prior_modes){
  V_A = ((nu+2)/nu)*p
  p_E = p_var - p - p_C
  V_E = ((nu+2)/nu)*p_E
  
  prior = list(R=list(V=V_E,nu=0.001),G=list(G1=list(V=V_A,nu=0.001),G2=list(V=V_C,nu=0.001)))
  model <- MCMCglmm(length~1+age,
                    random=~animal+clutch,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)
  v_mcmc <- model$VCV
  effSamp=effectiveSize(v_mcmc)

  #VA
  animal_samples = as.data.frame(model$VCV)$animal
  quants = quantile(animal_samples,c(0.05,0.25,0.5,0.75,0.95))
  post_density = density(animal_samples)
  post_mode = post_density$x[which.max(post_density$y)]
  effSampA = as.data.frame(t(effSamp))$animal
  newrow=c(p,p_E,p_C,effSampA,post_mode,as.numeric(quants))
  VA_samples = rbind(VA_samples,newrow)

  #VC
  clutch_samples = as.data.frame(model$VCV)$clutch
  quants = quantile(clutch_samples,c(0.05,0.25,0.5,0.75,0.95))
  post_density = density(clutch_samples)
  post_mode = post_density$x[which.max(post_density$y)]
  effSampC = as.data.frame(t(effSamp))$clutch
  newrow=c(p,p_E,p_C,effSampC,post_mode,as.numeric(quants))
  VC_samples = rbind(VC_samples,newrow)

  #VE
  units_samples = as.data.frame(model$VCV)$units
  quants = quantile(units_samples,c(0.05,0.25,0.5,0.75,0.95))
  post_density = density(units_samples)
  post_mode = post_density$x[which.max(post_density$y)]
  effSampE = as.data.frame(t(effSamp))$units
  newrow=c(p,p_E,p_C,effSampE,post_mode,as.numeric(quants))
  VE_samples = rbind(VE_samples,newrow)

  #save model run for further use
  save(model,file=paste0('../model_runs/prior_sensitivity/Again/SL_noparent_p=',round(p,3),'.RData'))
  print(p)
}

colnames(VA_samples)=c('prior_mode_A','prior_mode_E','prior_mode_C','effSampVA','post_mode','q5','q25','q50','q75','q95')
colnames(VC_samples)=c('prior_mode_A','prior_mode_E','prior_mode_C','effSampVC','post_mode','q5','q25','q50','q75','q95')
colnames(VE_samples)=c('prior_mode_A','prior_mode_E','prior_mode_C','effSampVE','post_mode','q5','q25','q50','q75','q95')

save(VA_samples,file='../model_runs/prior_sensitivity/Again/SL_noparent_VA.RData')
save(VC_samples,file='../model_runs/prior_sensitivity/Again/SL_noparent_VC.RData')
save(VE_samples,file='../model_runs/prior_sensitivity/Again/SL_noparent_VE.RData')
```

Plot priors vs posteriors.
Black points (modes) and intervals (5%-95% regions) are posterior estimates of VA, with prior mode indicated by x-axis value.
Blue points (modes) and intervals (5%-95% regions) are posterior estimates of VE, with prior mode chosen so the prior modes of VA, VE, and VC add up to the total phenotypic variance.
Black diagonal line is 1-1.
Purple vertical line is the prior value we actually used.
Red line is (scaled) effective sample size for VA (an indication of how well the MCMC algorithm worked).
```{r}
p_var = var(phens$length,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
nu = 0.001

load(file='../model_runs/prior_sensitivity/Again/SL_noparent_VA.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_noparent_VC.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_noparent_VE.RData')

ggplot(data=VA_samples,aes(x=prior_mode_A,y=post_mode))+
  geom_point()+
  geom_line()+
  xlab('Prior Mode of VA')+
  ylab('Posterior Mode and 5%-95% range')+
  ggtitle('Prior vs posterior modes, VA (black) and VE (blue) of SL')+
  geom_errorbar(aes(ymin=q5, ymax=q95),width=0.0001)+
  geom_point(data=VE_samples,aes(x=prior_mode_A+.0001,y=post_mode),color='blue')+
  geom_line(data=VE_samples,aes(x=prior_mode_A+.0001,y=post_mode),color='blue')+
  geom_errorbar(data=VE_samples,aes(x=prior_mode_A+.0001,ymin=q5, ymax=q95),color='blue',width=0.0001)+
  geom_abline(slope=1,intercept=0)+
  geom_vline(xintercept=p_var/3,color='purple')+
  geom_line(data=VA_samples,aes(x=prior_mode_A,y=effSampVA*(0.02/600)),color='red')
```

```{r}
p_var = var(phens$length,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
nu = 0.001

load(file='../model_runs/prior_sensitivity/Again/SL_noparent_VA.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_noparent_VC.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_noparent_VE.RData')

ggplot(data=VA_samples,aes(x=prior_mode_A,y=post_mode))+
  geom_point()+
  geom_line()+
  xlab('Prior Mode of VA')+
  ylab('Posterior Mode and 5%-95% range')+
  ggtitle('Prior vs posterior modes, VA (black) and VE (blue) of SL')+
  geom_errorbar(aes(ymin=q5, ymax=q95),width=0.0001)+
  geom_point(data=VE_samples,aes(x=prior_mode_A+.0001,y=post_mode),color='blue')+
  geom_line(data=VE_samples,aes(x=prior_mode_A+.0001,y=post_mode),color='blue')+
  geom_errorbar(data=VE_samples,aes(x=prior_mode_A+.0001,ymin=q5, ymax=q95),color='blue',width=0.0001)+
  geom_abline(slope=1,intercept=0)+
  geom_vline(xintercept=p_var/3,color='purple')+
  geom_line(data=VA_samples,aes(x=prior_mode_A,y=effSampVA*(0.02/600)),color='red')
```

```{r}
p_var = var(phens$length,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
herit_samples = data.frame()

for(p in prior_modes){
  load(file=paste0('../model_runs/prior_sensitivity/Again/SL_noparent_p=',round(p,3),'.RData'))
  herit <- model$VCV[,1]/rowSums(as.data.frame(model$VCV)) #store them in a list
  v_estimates <- data.frame(prior_mode_A = p, effSamph2 = effectiveSize(herit), post_modeh2 = posterior.mode(herit),
                            upper95h2=HPDinterval(herit)[,2],lower95h2=HPDinterval(herit)[,1])
  herit_samples=rbind(herit_samples,v_estimates)
}

ggplot(data=herit_samples,aes(x=prior_mode_A,y=post_modeh2))+
    geom_point()+
    geom_line()+
    geom_errorbar(aes(ymin=lower95h2,ymax=upper95h2))
```

Plot example priors and posteriors for a single run
```{r}
load(file='../model_runs/prior_sensitivity/Again/SL_noparent_VA.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_noparent_VC.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_noparent_VE.RData')


i = 12 #plot the model in the ith row of the samples tables

load(file=paste0('../model_runs/prior_sensitivity/Again/SL_noparent_p=',round(prior_modes[i],3),'.RData'))
V_A = VA_samples$prior_mode_A[i]*(nu+2)/nu
V_C = VA_samples$prior_mode_C[i]*(nu+2)/nu
V_E = VA_samples$prior_mode_E[i]*(nu+2)/nu
plot_priorandpost_new(model,nu.=nu,V_A=V_A,V_C=V_C,V_E=V_E,xlim=p_var)
```

### SL, with parents

First, generate the model runs.

Total phenotypic variance in Ucrit is 0.015. We're estimating five components of variance: VA, VC, VD, VS, and VE. Each run will use a different set of prior distributions for the variance components. All priors will be inverse gamma with nu = 0.001 (i.e., very flat), so they can be uniquely defined by the mode (peak).

- We'll keep the mode of the prior for VC the same for all runs: 0.0025. (This is a good guess for the actual value, based on previous tries.)
- Set VD and VS prior modes to 0.65 also. This is probably a little high.
- For each run, choose the prior mode of VA from a sequence running from 0 to the total phenotypic variance (minus the VC, VD, and VS modes).
- Then define the prior mode of VE so that the five prior modes add up to the total phenotypic variance.

[Checked with other values for VC, VD, and VS prior modes: ______________. Increasing prior mode increases estimate of each of these variance components, which decreases estimate of VA and doesn't affect estimate of VE. This is pretty much what we'd expect.]
Second run: same thing, but VC, VD and VS prior modes are all 0.0001.
*Third run*: same thing, but VC prior mode = 0.0015, VD prior mode = 0.0025, and VS prior mode = 0.0023 (matching results from manuscript).

```{r,eval=FALSE,echo=FALSE}
p_var = var(phens$length,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
nu = 0.001

#set prior modes for clutch and parents at reasonable-to-high estimate of 0.65; stays the same for all of these model runs
p_C = 0.1*p_var
V_C = ((nu+2)/nu)*p_C
p_D = 0.16*p_var
V_D = ((nu+2)/nu)*p_D
p_S = 0.15*p_var
V_S = ((nu+2)/nu)*p_S

# Run model for range of priors and store results
VA_samples = data.frame(matrix(ncol=10,nrow=0))
VC_samples = data.frame(matrix(ncol=10,nrow=0))
VD_samples = data.frame(matrix(ncol=10,nrow=0))
VS_samples = data.frame(matrix(ncol=10,nrow=0))
VE_samples = data.frame(matrix(ncol=10,nrow=0))

for(p in prior_modes){
  V_A = ((nu+2)/nu)*p
  p_E = p_var - p - (p_C+p_D+p_S)
  V_E = ((nu+2)/nu)*p_E
  
  prior = list(R=list(V=V_E,nu=0.001),G=list(G1=list(V=V_A,nu=0.001),G2=list(V=V_C,nu=0.001),G3=list(V=V_D,nu=0.001),G4=list(V=V_S,nu=0.001)))
  model <- MCMCglmm(length~1+age,
                    random=~animal+clutch+dam+sire,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)
  v_mcmc <- model$VCV
  effSamp=effectiveSize(v_mcmc)

  #VA
  animal_samples = as.data.frame(model$VCV)$animal
  quants = quantile(animal_samples,c(0.05,0.25,0.5,0.75,0.95))
  post_density = density(animal_samples)
  post_mode = post_density$x[which.max(post_density$y)]
  effSampA = as.data.frame(t(effSamp))$animal
  newrow=c(p,p_E,p_C,effSampA,post_mode,as.numeric(quants))
  VA_samples = rbind(VA_samples,newrow)

  #VC
  clutch_samples = as.data.frame(model$VCV)$clutch
  quants = quantile(clutch_samples,c(0.05,0.25,0.5,0.75,0.95))
  post_density = density(clutch_samples)
  post_mode = post_density$x[which.max(post_density$y)]
  effSampC = as.data.frame(t(effSamp))$clutch
  newrow=c(p,p_E,p_C,effSampC,post_mode,as.numeric(quants))
  VC_samples = rbind(VC_samples,newrow)
  
  #VD
  dam_samples = as.data.frame(model$VCV)$dam
  quants = quantile(dam_samples,c(0.05,0.25,0.5,0.75,0.95))
  post_density = density(dam_samples)
  post_mode = post_density$x[which.max(post_density$y)]
  effSampD = as.data.frame(t(effSamp))$dam
  newrow=c(p,p_E,p_C,effSampD,post_mode,as.numeric(quants))
  VD_samples = rbind(VD_samples,newrow)
  
  #VS
  sire_samples = as.data.frame(model$VCV)$sire
  quants = quantile(sire_samples,c(0.05,0.25,0.5,0.75,0.95))
  post_density = density(sire_samples)
  post_mode = post_density$x[which.max(post_density$y)]
  effSampS = as.data.frame(t(effSamp))$sire
  newrow=c(p,p_E,p_C,effSampS,post_mode,as.numeric(quants))
  VS_samples = rbind(VS_samples,newrow)

  #VE
  units_samples = as.data.frame(model$VCV)$units
  quants = quantile(units_samples,c(0.05,0.25,0.5,0.75,0.95))
  post_density = density(units_samples)
  post_mode = post_density$x[which.max(post_density$y)]
  effSampE = as.data.frame(t(effSamp))$units
  newrow=c(p,p_E,p_C,effSampE,post_mode,as.numeric(quants))
  VE_samples = rbind(VE_samples,newrow)

  #save model run for further use
  save(model,file=paste0('../model_runs/prior_sensitivity/Again/SL_withparent3_p=',round(p,3),'.RData'))
  print(p)
}

colnames(VA_samples)=c('prior_mode_A','prior_mode_E','prior_mode_C','effSampVA','post_mode','q5','q25','q50','q75','q95')
colnames(VC_samples)=c('prior_mode_A','prior_mode_E','prior_mode_C','effSampVC','post_mode','q5','q25','q50','q75','q95')
colnames(VD_samples)=c('prior_mode_A','prior_mode_E','prior_mode_C','effSampVD','post_mode','q5','q25','q50','q75','q95')
colnames(VS_samples)=c('prior_mode_A','prior_mode_E','prior_mode_C','effSampVS','post_mode','q5','q25','q50','q75','q95')
colnames(VE_samples)=c('prior_mode_A','prior_mode_E','prior_mode_C','effSampVE','post_mode','q5','q25','q50','q75','q95')

save(VA_samples,file='../model_runs/prior_sensitivity/Again/SL_withparent3_VA.RData')
save(VC_samples,file='../model_runs/prior_sensitivity/Again/SL_withparent3_VC.RData')
save(VD_samples,file='../model_runs/prior_sensitivity/Again/SL_withparent3_VD.RData')
save(VS_samples,file='../model_runs/prior_sensitivity/Again/SL_withparent3_VS.RData')
save(VE_samples,file='../model_runs/prior_sensitivity/Again/SL_withparent3_VE.RData')
```

```{r}
p_var = var(phens$length,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
herit_samples = data.frame()

for(p in prior_modes){
  load(file=paste0('../model_runs/prior_sensitivity/Again/SL_withparent_p=',round(p,3),'.RData'))
  herit <- model$VCV[,1]/rowSums(as.data.frame(model$VCV)) #store them in a list
  v_estimates <- data.frame(prior_mode_A = p, effSamph2 = effectiveSize(herit), post_modeh2 = posterior.mode(herit),
                            upper95h2=HPDinterval(herit)[,2],lower95h2=HPDinterval(herit)[,1])
  herit_samples=rbind(herit_samples,v_estimates)
}

ggplot(data=herit_samples,aes(x=prior_mode_A,y=post_modeh2))+
    geom_point()+
    geom_line()+
    geom_errorbar(aes(ymin=lower95h2,ymax=upper95h2))
```

Plot priors vs posteriors.
Black points (modes) and intervals (5%-95% regions) are posterior estimates of VA, with prior mode indicated by x-axis value.
Blue points (modes) and intervals (5%-95% regions) are posterior estimates of VE, with prior mode chosen so the prior modes of VA, VE, and VC add up to the total phenotypic variance.
Black diagonal line is 1-1.
Purple vertical line is the prior value we actually used.
Red line is (scaled) effective sample size for VA (an indication of how well the MCMC algorithm worked).
```{r,eval=FALSE,echo=FALSE}
p_var = var(phens$length,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
nu = 0.001

load(file='../model_runs/prior_sensitivity/Again/SL_withparent_VA.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_withparent_VC.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_withparent_VD.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_withparent_VS.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_withparent_VE.RData')

ggplot(data=VA_samples,aes(x=prior_mode_A,y=post_mode))+
  geom_point()+
  geom_line()+
  xlab('Prior Mode of VA')+
  ylab('Posterior Mode and 5%-95% range')+
  ggtitle('Prior vs posterior modes, VA (black) and VE (blue) of SL [Model with parental effects]')+
  geom_errorbar(aes(ymin=q5, ymax=q95),width=0.0001)+
  geom_point(data=VC_samples,aes(x=prior_mode_A+.00005,y=post_mode),color='purple')+
  geom_line(data=VC_samples,aes(x=prior_mode_A+.00005,y=post_mode),color='purple')+
  geom_errorbar(data=VC_samples,aes(x=prior_mode_A+.00005,ymin=q5, ymax=q95),color='purple',width=0.0001)+
  geom_point(data=VD_samples,aes(x=prior_mode_A+.0001,y=post_mode),color='green')+
  geom_line(data=VD_samples,aes(x=prior_mode_A+.0001,y=post_mode),color='green')+
  geom_errorbar(data=VD_samples,aes(x=prior_mode_A+.0001,ymin=q5, ymax=q95),color='green',width=0.0001)+
  geom_point(data=VS_samples,aes(x=prior_mode_A+.00015,y=post_mode),color='orange')+
  geom_line(data=VS_samples,aes(x=prior_mode_A+.00015,y=post_mode),color='orange')+
  geom_errorbar(data=VS_samples,aes(x=prior_mode_A+.00015,ymin=q5, ymax=q95),color='orange',width=0.0001)+
  geom_point(data=VE_samples,aes(x=prior_mode_A+.0002,y=post_mode),color='blue')+
  geom_line(data=VE_samples,aes(x=prior_mode_A+.0002,y=post_mode),color='blue')+
  geom_errorbar(data=VE_samples,aes(x=prior_mode_A+.0002,ymin=q5, ymax=q95),color='blue',width=0.0001)+
  geom_abline(slope=1,intercept=0,lty='dashed')+
  geom_vline(xintercept=p_var/3,color='purple')+
  geom_line(data=VA_samples,aes(x=prior_mode_A,y=effSampVA*(0.02/700)),color='red')
```

```{r,eval=FALSE,echo=FALSE}
p_var = var(phens$length,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
nu = 0.001

load(file='../model_runs/prior_sensitivity/Again/SL_withparent2_VA.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_withparent2_VC.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_withparent2_VD.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_withparent2_VS.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_withparent2_VE.RData')

ggplot(data=VA_samples,aes(x=prior_mode_A,y=post_mode))+
  geom_point()+
  geom_line()+
  xlab('Prior Mode of VA')+
  ylab('Posterior Mode and 5%-95% range')+
  ggtitle('Prior vs posterior modes, VA (black) and VE (blue) of SL [Model with parental effects]')+
  geom_errorbar(aes(ymin=q5, ymax=q95),width=0.0001)+
  geom_point(data=VC_samples,aes(x=prior_mode_A+.00005,y=post_mode),color='purple')+
  geom_line(data=VC_samples,aes(x=prior_mode_A+.00005,y=post_mode),color='purple')+
  geom_errorbar(data=VC_samples,aes(x=prior_mode_A+.00005,ymin=q5, ymax=q95),color='purple',width=0.0001)+
  geom_point(data=VD_samples,aes(x=prior_mode_A+.0001,y=post_mode),color='green')+
  geom_line(data=VD_samples,aes(x=prior_mode_A+.0001,y=post_mode),color='green')+
  geom_errorbar(data=VD_samples,aes(x=prior_mode_A+.0001,ymin=q5, ymax=q95),color='green',width=0.0001)+
  geom_point(data=VS_samples,aes(x=prior_mode_A+.00015,y=post_mode),color='orange')+
  geom_line(data=VS_samples,aes(x=prior_mode_A+.00015,y=post_mode),color='orange')+
  geom_errorbar(data=VS_samples,aes(x=prior_mode_A+.00015,ymin=q5, ymax=q95),color='orange',width=0.0001)+
  geom_point(data=VE_samples,aes(x=prior_mode_A+.0002,y=post_mode),color='blue')+
  geom_line(data=VE_samples,aes(x=prior_mode_A+.0002,y=post_mode),color='blue')+
  geom_errorbar(data=VE_samples,aes(x=prior_mode_A+.0002,ymin=q5, ymax=q95),color='blue',width=0.0001)+
  geom_abline(slope=1,intercept=0,lty='dashed')+
  geom_vline(xintercept=p_var/3,color='purple')+
  geom_line(data=VA_samples,aes(x=prior_mode_A,y=effSampVA*(0.02/700)),color='red')
```

[3rd run: same priors for VC, VD, VS each time; chosen based on means in manuscript.]
```{r,echo=FALSE}
p_var = var(phens$length,na.rm=TRUE) #test (phenotypic variance)
prior_modes = p_var*c(0.01,seq(0.05,1,by=0.05)) # test a range of modes from 1% to 100% of the phenotypic variance
nu = 0.001

p_C = 0.1*p_var
V_C = ((nu+2)/nu)*p_C
p_D = 0.16*p_var
V_D = ((nu+2)/nu)*p_D
p_S = 0.15*p_var
V_S = ((nu+2)/nu)*p_S

load(file='../model_runs/prior_sensitivity/Again/SL_withparent3_VA.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_withparent3_VC.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_withparent3_VD.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_withparent3_VS.RData')
load(file='../model_runs/prior_sensitivity/Again/SL_withparent3_VE.RData')

ggplot(data=VA_samples,aes(x=prior_mode_A,y=post_mode))+
  geom_point()+
  geom_line()+
  xlab('Prior Mode of VA')+
  ylab('Posterior Mode and 5%-95% range')+
  ggtitle('Prior vs posterior modes, VA (black) and VE (blue) of SL [Model with parental effects]')+
  geom_errorbar(aes(ymin=q5, ymax=q95),width=0.0001)+
  geom_point(data=VC_samples,aes(x=prior_mode_A+.00005,y=post_mode),color='purple')+
  geom_line(data=VC_samples,aes(x=prior_mode_A+.00005,y=post_mode),color='purple')+
  geom_errorbar(data=VC_samples,aes(x=prior_mode_A+.00005,ymin=q5, ymax=q95),color='purple',width=0.0001)+
  geom_abline(slope = 0,intercept=p_C,color='purple',lty='dotted')+
  geom_point(data=VD_samples,aes(x=prior_mode_A+.0001,y=post_mode),color='green')+
  geom_line(data=VD_samples,aes(x=prior_mode_A+.0001,y=post_mode),color='green')+
  geom_errorbar(data=VD_samples,aes(x=prior_mode_A+.0001,ymin=q5, ymax=q95),color='green',width=0.0001)+
  geom_abline(slope = 0,intercept=p_D,color='green',lty='dotted')+
  geom_point(data=VS_samples,aes(x=prior_mode_A+.00015,y=post_mode),color='orange')+
  geom_line(data=VS_samples,aes(x=prior_mode_A+.00015,y=post_mode),color='orange')+
  geom_errorbar(data=VS_samples,aes(x=prior_mode_A+.00015,ymin=q5, ymax=q95),color='orange',width=0.0001)+
  geom_abline(slope = 0,intercept=p_S,color='orange',lty='dotted')+
  geom_point(data=VE_samples,aes(x=prior_mode_A+.0002,y=post_mode),color='blue')+
  geom_line(data=VE_samples,aes(x=prior_mode_A+.0002,y=post_mode),color='blue')+
  geom_errorbar(data=VE_samples,aes(x=prior_mode_A+.0002,ymin=q5, ymax=q95),color='blue',width=0.0001)+
  geom_abline(slope=1,intercept=0,lty='dashed')+
  geom_vline(xintercept=p_var/3,color='purple')+
  geom_line(data=VA_samples,aes(x=prior_mode_A,y=effSampVA*(0.02/700)),color='red')
```

## Bivariate animal model

Getting good convergence with the bivariate model is difficult. I tried lots of prior distributions. Below are results for the best I could get: marginal priors for the clutch effects centered close to 0, marginal priors for residual effects centered close to 1, and parameter-expanded priors for genetic effects. This is all for the model without parental effects: [speed,length]~ animal + clutch + residual.

A few things to note:
- There is no evidence of genetic correlation between SL and Ucrit. The posterior is centered symmetrically around zero.
- It's hard to draw conclusions about the estimates of genetic variance in SL and Ucrit, because the convergence isn't great, but they seem broadly to be in agreement with what we find with the univariate models. The estimate for Ucrit is essentially zero. The posterior for SL is bimodal: it appears to be getting stuck at zero, but there's also some mass farther out.
- Since we can be pretty clear that there's no genetic correlation, I think we're justified in proceeding with the univariate models.
- There's also no evidence of correlation associated with the residual effect. I think this means that, after controlling for clutch and relatedness, there's no relationship between an individual's size and its swimming speed. (i.e., larger individuals aren't likely to be faster)
- There does appear to be a significant positive clutch-level covariance between SL and Ucrit. I think this means that clutches with larger larvae also tend to have faster larvae -- although this trend isn't driven by relatedness, and the larger individuals within a clutch aren't necessarily the faster ones.

```{r}
### All the priors I tried and didn't use

# #all the convergence diagnostics are amazing, but the output doesn't really make sense. It estimates variance components =~ 20, when the phenotypes were normalized (so total variance=1) ahead of time
# #the prior mode is like 200, which probably explains it. Don't know where I got this prior in the first place.
# prior<-list(R=list(V=diag(2)/(0.002/1.002),nu=1.002),
#             G=list(G1=list(V=diag(2)/(0.002/1.002),nu=1.002),
#                    G2=list(V=diag(2)/(0.002/1.002),nu=1.002)))
      # Plot marginal distribution
      # V = diag(2)/(0.002/1.002)
      # nu = 1.002
      # nustar = nu-2+1
      # Vstar = (nu/nustar)*V[1,1]
      # shape = nustar/2
      # scale = nustar*Vstar/2
      # xlim = seq(0,1000,by=0.1)
      # plot(xlim,dinvgamma(xlim,shape=shape,scale=scale),type='l')


# psi=1/3 #don't know where I got this or what psi is
# prior<-list(R=list(V=psi*diag(2),nu=nu),
#             G=list(G1=list(V=psi*diag(2),nu=nu),
#                    G2=list(V=psi*diag(2),nu=nu)))
      # Plot marginal distribution
      # V = psi*diag(2)
      # nu = 1.002
      # nustar = nu-2+1
      # Vstar = (nu/nustar)*V[1,1]
      # shape = nustar/2
      # scale = nustar*Vstar/2
      # xlim = seq(0,1,by=0.001)
      # plot(xlim,dinvgamma(xlim,shape=shape,scale=scale),type='l')


# #Hadfield p.71
# #very terrible
# prior<-list(R=list(V=diag(2)*0.02,nu=3),
#             G=list(G1=list(V=diag(2)*0.02,nu=3),
#                    G2=list(V=diag(2)*0.02,nu=3)))

# #parameter-expanded
# #also bad
# #https://stat.ethz.ch/pipermail/r-sig-mixed-models/2013q2/020396.html
# prior<-list(R=list(V=diag(2),nu=2),
#             G=list(G1=list(V=diag(2),nu=2,alpha.mu=c(0,0),alpha.V=diag(2)),
#                    G2=list(V=diag(2),nu=2,alpha.mu=c(0,0),alpha.V=diag(2))))


# #https://stat.ethz.ch/pipermail/r-sig-mixed-models/2011q1/015916.html
# #doesn't mix nearly as well as the first one, but the output makes more sense (estimated variance components are on the scale of the phenotypic variance (i.e., 1), rather than an order of magnitude larger)
# prior<-list(R=list(V=diag(2),nu=1.002),
#             G=list(G1=list(V=diag(2),nu=2,alpha.mu=c(0,0),alpha.V=diag(2)*1000),
#                    G2=list(V=diag(2),nu=2,alpha.mu=c(0,0),alpha.V=diag(2)*1000)))
      # Plot marginal distribution
      # nu=1.002
      # nustar=nu-2+1
      # Vmult=1
      # Vstar = Vmult*nu/nustar
      # shape = nustar/2
      # scale = nustar*Vstar/2
      # xlim = seq(0,1,by=0.001)
      # plot(xlim,dinvgamma(xlim,shape=shape,scale=scale),type='l')
```

```{r,eval=FALSE}
#normalize phenotypic traits (mean=0,variance=1)
phens_norm=transmute(phens,animal=animal,speed=scale(speed),length=scale(length),clutch=clutch)

# #kind of like the univariate prior: set R=~1, G=~0; small nu so it's flat
# #use parameter expansion for G1 (animal)
prior<-list(R=list(V=diag(2)*1.998,nu=1.0002),
            G=list(G1=list(V=diag(2),nu=2,alpha.mu=c(0,0),alpha.V=diag(2)*1000),
                   G2=list(V=diag(2)*.01998,nu=1.0002)))
      # Choose nu=1.002 (so nustar -- of marginal distribution -- is 0.002).
      # Then calculate what V should be multiplied by to give a marginal distribution w/mode=1
      # nu = 1.002
      # nustar = nu-2+1
      # mode = 1
      # Vstar = mode*(nustar+2)/nustar
      # Vmult = nustar*Vstar/nu

      # Plot marginal distribution
      # shape = nustar/2
      # scale = nustar*Vstar/2
      # xlim = seq(0,1,by=0.001)
      # plot(xlim,dinvgamma(xlim,shape=shape,scale=scale),type='l')


modelmulti<-MCMCglmm(cbind(speed,length)~trait-1,
                     random=~us(trait):animal+us(trait):clutch,
                     rcov=~us(trait):units,
                     family=c("gaussian","gaussian"),
                     prior=prior,
                     ginverse=list(animal=Ainv),
                     data=phens_norm,nitt=500000,burnin=50000,thin=50)
```

```{r}
load(file='../model_runs/bivariate.RData')

summary(modelmulti)
plot(modelmulti)
autocorr(modelmulti$VCV)
HPDinterval(modelmulti$VCV)
posterior.mode(modelmulti$VCV)
```

```{r}
##Calculate heritability of each trait

#SL
heritSL=modelmulti$VCV[,"traitlength:traitlength.animal"]/
  (modelmulti$VCV[,"traitlength:traitlength.animal"]
   +modelmulti$VCV[,"traitlength:traitlength.clutch"]
   +modelmulti$VCV[,"traitlength:traitlength.units"])
plot(heritSL)
autocorr(heritSL)
effectiveSize(heritSL)
  #then look at results
  posterior.mode(heritSL)
  mean(heritSL)
  HPDinterval(heritSL)

#Ucrit
heritUcrit=modelmulti$VCV[,"traitspeed:traitspeed.animal"]/
  (modelmulti$VCV[,"traitspeed:traitspeed.animal"]
   +modelmulti$VCV[,"traitspeed:traitspeed.clutch"]
   +modelmulti$VCV[,"traitspeed:traitspeed.units"])
plot(heritUcrit)
autocorr(heritUcrit)
effectiveSize(heritUcrit)
  #then look at results
  posterior.mode(heritUcrit)
  mean(heritUcrit)
  HPDinterval(heritUcrit)
```

```{r}
##Variance-covariance matrices
  
#Genetic variance-covariance matrix
#(speed:speed.animal, length:speed.animal, speed:length.animal,length:length.animal)
G_elements<-c(mean(modelmulti$VCV[,1]), mean(modelmulti$VCV[,2]), 
              mean(modelmulti$VCV[,3]), mean(modelmulti$VCV[,4]))
#Trace of genetic correlation
corr.gen=modelmulti$VCV[,"traitspeed:traitlength.animal"]/
  sqrt(modelmulti$VCV[,"traitspeed:traitspeed.animal"]
       *modelmulti$VCV[,"traitlength:traitlength.animal"])
  #Evaluate genetic correlation
  autocorr(corr.gen) #first, check autocorrelation
  plot(corr.gen)
  HPDinterval(corr.gen)
  posterior.mode(corr.gen)
#Plot genetic covariance nicely
var_anim2=modelmulti$VCV[,"traitspeed:traitlength.animal"]
autocorr(var_anim2)
plot(var_anim2)
HPDinterval(var_anim2)
posterior.mode(var_anim2)
effectiveSize(var_anim2)

var_anim2=as.data.frame(var_anim2)
colnames(var_anim2)=c('genetic covariance')
mcmc_areas(var_anim2,prob=0.95,pars=c('genetic covariance'),area_method='equal height')

  
#Clutch variance-covariance matrix
#(speed:speed.clutch, length:speed.clutch, speed:length.clutch,length:length.clutch)
C_elements<-c(mean(modelmulti$VCV[,5]), mean(modelmulti$VCV[,6]), 
              mean(modelmulti$VCV[,7]), mean(modelmulti$VCV[,8]))
#Trace of clutch correlation
corr.clutch=modelmulti$VCV[,"traitspeed:traitlength.clutch"]/
  sqrt(modelmulti$VCV[,"traitspeed:traitspeed.clutch"]
       *modelmulti$VCV[,"traitlength:traitlength.clutch"])
  #Evaluate clutch correlation
  autocorr(corr.clutch)
  plot(corr.clutch)
  HPDinterval(corr.clutch)
  posterior.mode(corr.clutch)
  
var_clutch=modelmulti$VCV[,"traitspeed:traitlength.clutch"]
autocorr(var_clutch)
plot(var_clutch)
HPDinterval(var_clutch)
posterior.mode(var_clutch)
effectiveSize(var_clutch)

#Residual variance-covariance matrix
#(speed:speed.units, length:speed.units, speed:length.units,length:length.units)
R_elements<-c(mean(modelmulti$VCV[,9]), mean(modelmulti$VCV[,10]), 
              mean(modelmulti$VCV[,11]), mean(modelmulti$VCV[,12]))
#Trace of residual correlation
corr.units=modelmulti$VCV[,"traitspeed:traitlength.units"]/
  sqrt(modelmulti$VCV[,"traitspeed:traitspeed.units"]
       *modelmulti$VCV[,"traitlength:traitlength.units"])
  #Evaluate
  autocorr(corr.units)
  plot(corr.units)
  HPDinterval(corr.units)
  posterior.mode(corr.units)
  
var_units=modelmulti$VCV[,"traitspeed:traitlength.units"]
autocorr(var_units)
plot(var_units)
HPDinterval(var_units)
posterior.mode(var_units)
effectiveSize(var_units)
```