---
title: "Amphiprion percula Larval Trait Heritability"
author: "E Schlatter"
date: "12/18/2021"
output: html_document
---

##Read in and process the data.

Creates the following objects we'll use going forward:

$\textbf{phens}$: a list of each larva and its swimming speed and clutch (+other covariates to be added). (Each parent also has a row in this list, to be compatible with relatedness matrix, but its swimming speed and covariates are all NA.)

$\textbf{Ainv}$: the inverse of the relatedness matrix, A. In A, $A_{ij}=$probability of identity by descent of an allele in individuals i and j.
```{r}
larvae=as.data.frame(read.csv('Larvae.csv',header=TRUE))
larvae=mutate(larvae,larvalID=Clutch+.01*Larva) #create unique identifier for each larva

metadata=as.data.frame(read.csv('metadata_SL.csv',header=TRUE))
colnames(metadata)[1]='Clutch'

lengths=as.data.frame(read.csv('Lengths.csv',header=TRUE))
lengths=mutate(lengths,larvalID=Clutch+.01*Larva) #create unique identifier for each larva
lengths=dplyr::select(lengths,-Clutch,-Larva)

larvae=merge(larvae,lengths,by='larvalID')
larvae=rename(larvae,SL=Average.length)
larvae$SL=as.numeric(larvae$SL)  #this will give "NAs introduced by coercion" -- that's fine
for(i in 1:nrow(larvae)){larvae$SL[i]=ifelse(larvae$Dead.before.preservation.[i]==1,NA,larvae$SL[i])} #remove SL measurements for dead larvae
#add a Time column
larvae=mutate(larvae,'Time'=Time.min.+(1/60)*Time.sec.)
larvae=subset(larvae,Clutch>4) #first four clutches didn't count
larvae$Clutch=as.factor(larvae$Clutch)
larvae$larvalID=as.factor(larvae$larvalID)

#merge the larvae and metadata data frames, so metadata info is associated with each larva
larvae=merge(larvae,metadata,by='Clutch')
larvae=dplyr::select(larvae,larvalID,everything()) #move larvalID to first column

larvae=subset(larvae,is.na(SL)==FALSE) #remove larvae with no SL measurement
larvae=subset(larvae,is.na(Time)==FALSE) #remove larvae with no speed measurement
larvae=mutate(larvae,speed=Time-2) #Ucrit is swim time minus 2cm/sec

#If you uncomment this, everything will use the twice-trimmed dataset
mothers_bothgood=c(5,6,9,10,13,18,22,30,59,66,70,114)
fathers_bothgood=c(38,96,97,98,103,108,111,115,131,156,165,171)
metadata=subset(metadata,R1.ID.%in%mothers_bothgood&R2.ID.%in%fathers_bothgood)
larvae=subset(larvae,R1.ID.%in%mothers_bothgood&R2.ID.%in%fathers_bothgood)

#pedigree and Ainv -- we'll need this later for heritability analysis
pedigree=dplyr::select(larvae,id=larvalID,dam=R1.ID.,sire=R2.ID.)
full_pedig=insertPed(pedigree)  #pedigree utility functions to insert parents and correctly order, from MasterBayes.
full_pedig=orderPed(full_pedig)
Ainv=inverseA(full_pedig)$Ainv

#make sure all covariates are in the right format
larvae$R1.ID.=as.factor(larvae$R1.ID.)
larvae$R2.ID.=as.factor(larvae$R2.ID.)
larvae$Date=as.Date(larvae$Date, "%d-%b-%y")
larvae$PostSwitch=as.factor(larvae$PostSwitch)
larvae$Parental.tank=as.factor(larvae$Parental.tank)
# #scale SL to N(0,1)
# larvae$SL=scale(larvae$SL,center=TRUE)

#phenotype data frame
phens=dplyr::select(larvae,animal=larvalID,speed=speed, length=SL, clutch=Clutch, dam=R1.ID., sire=R2.ID., tank=Parental.tank, age=Age.at.hatch)
#add empty rows to phens for parents
parents=subset(full_pedig,is.na(dam))
parents=transmute(parents,animal=id,speed=as.numeric(dam),length=as.numeric(dam),clutch=NA,dam=NA,sire=NA,tank=NA,age=1)
phens=as.data.frame(phens)
phens=rbind(parents,phens)

#clean up a bit: get just the potentially relevant columns of larvae
larvae_cov=dplyr::select(larvae,larvalID,SL,speed,Clutch,Date,R1.ID.,R2.ID.,Parental.tank,PostSwitch,Age.at.hatch,R1_SL,R2_SL,Notes)
```