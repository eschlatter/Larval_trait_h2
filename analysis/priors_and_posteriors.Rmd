---
title: 'Larval h2 analysis: priors and posteriors'
author: "E Schlatter"
date: "6/14/2022"
output:
  html_document: default
  pdf_document: default
---

```{r,warning=FALSE,message=FALSE, echo=FALSE}
library(MCMCpack)
library(tidyverse)
library(bayesplot)

plot_priorandpost_VA <- function(model,nu.,V.){
xlim=0.04

#calculate modes of both distributions
xvals = seq(0,xlim,length.out=nrow(model$VCV))
prior_mode = xvals[which.max(dinvgamma(xvals,shape = nu./2,scale = nu.*V./2))]

#plot (VA)
animal_samples = as.data.frame(model$VCV)$animal
post_density = density(animal_samples)
post_mode = post_density$x[which.max(post_density$y)]

colors=c('Prior'='blue','Posterior'='red')

g <- ggplot(as.data.frame(model$VCV), aes(x=animal)) + 
  geom_density(aes(color='Posterior'))+
  geom_line(aes(x = seq(0,xlim,length.out=nrow(model$VCV)), 
                y = dinvgamma(xvals,shape = nu./2,scale = nu.*V./2),
                color='Prior'))+
  geom_vline(aes(xintercept = prior_mode, color='Prior'))+
  geom_vline(aes(xintercept = post_mode, color='Posterior'))+
  labs(color='Legend')+
  xlab('VA estimate')+
  ylab('density')+
  scale_color_manual(values=colors)+
  ggtitle(paste('V=',V.,' nu=',nu.))+
  annotate('text', x=c(prior_mode,post_mode),y=c(10,20),label=c(as.character(round(prior_mode,4)),as.character(round(post_mode,4))),colour = c('blue','red'))
print(g)

}

model_results <- function(model){
  #proportional variances as new mcmc objects
  scaled_vars <- list()
  for(i in 1:ncol(model$VCV)){
    varname <- paste('scale',colnames(model$VCV)[i],sep='_')
    scaled_vars[[varname]] <- model$VCV[,i]/rowSums(as.data.frame(model$VCV)) #store them in a list
  }
  
  #plot histograms of variance estimates
  matrix_scaled_vars <- do.call(cbind,scaled_vars) #put all variables together into a matrix for plotting
  plot(mcmc_areas(matrix_scaled_vars,prob=0.95,area_method='scaled height')) #scaled to 1
}

load("../model_runs/priorpostmods.RData")
SL_noparent_oldprior = mods[[1]]
SL_noparent_newprior = mods[[2]]
SL_noparent_smallprior = mods[[3]]
SL_noparent_shuffle = mods[[4]]

load("../model_runs/NullEstVA.RData")
load("../model_runs/NullEstVA_corrected.RData")
load("../model_runs/phens.RData")

```


### Prior sensitivity

I've been looking at the sensitivity of estimates of variance components to what prior distribution is used. For example, let's look at estimating the additive genetic component of variance for standard length (in a model w/o parental effects). Here are the results for three different prior distributions:

1. What I used in the manuscript (V = 1, nu = 0.02; mode = 0.01)
2. Suggestion from reviewer (V = 10.31, nu = 0.001; mode = 0.005)
3. One with a much smaller mode, chosen somewhat arbitrarily (V = 1.55, nu = 0.001; mode = 0.0008)

Each plot shows the prior distribution in blue, and the posterior distribution in red. Vertical lines are the mode of each distribution. The priors look like a line at 0 because they're very flat, compared to the posteriors which have most of their probability concentrated in a very small range of values. 

```{r,echo=FALSE, warning=FALSE}
## prior 1
nu = 0.02
V = 1
#SL_noparent_oldprior <- model_run(list(V=V,nu=nu),'length',"animal+clutch",2,100000)
plot_priorandpost_VA(SL_noparent_oldprior,nu,V)

## prior 2
p_var = var(phens$length,na.rm=TRUE) #total phenotypic variance in SL ~ 0.015
# inverse gamma parameters
# mode of the inverse gamma (according to Hadfield) is V*nu/(nu+2). So if we want a mode of p_var/k (where k is the # of variance components),
# V = ((nu+2)/nu)*p_var/k
# k = 3 (animal, clutch, residual) or 5 (animal, clutch, maternal, paternal, residual)
nu = 0.001
V = ((nu+2)/nu)*p_var/3
#SL_noparent_newprior <- model_run(list(V=V,nu=nu),'length',"animal+clutch",2,100000)
plot_priorandpost_VA(SL_noparent_newprior,nu,V)

## prior 3
nu = 0.001
V = ((nu+2)/nu)*p_var/20
#SL_noparent_smallprior <- model_run(list(V=V,nu=nu),'length',"animal+clutch",2,100000)
plot_priorandpost_VA(SL_noparent_smallprior,nu,V)

```

In cases 1 and 2, the posterior estimates of additive genetic variance are smaller than the priors. In case 3, when we start with a very small prior, the posterior estimate is larger than the prior. Taken together, these three examples seem to indicate that the posterior is moving away from the prior in an appropriate direction to converge around some intermediate value (~0.0033-0.0055), but that the prior does have some influence (the posterior estimate isn't exactly the same in all cases). I think this is basically what we want to see -- although I'm not really sure what constitutes "too much" sensitivity to the prior.

I didn't include the plots for VE and VC here, but VE seems to vary with the priors to about the same extent as VA, while the estimate for VC is much lower but a little more consistent.


### Null expectation for posterior

I also wanted to know how this estimate deviates from what we'd expect if there truly was no additive genetic variance. I broke up any causal relationship between standard length and relatedness by shuffling SL's randomly among larvae. Using prior 1 from above (V=1, nu=0.02), the results look like this:

```{r,echo=FALSE, warning=FALSE}
nu = 0.02
V = 1

#shuffle SLs
randomize = c(c(1:24),sample(c(25:nrow(phens))))
SLs_rand = phens$length[randomize]
phens_rand = dplyr::select(phens,-length)
phens_rand = mutate(phens_rand,length = SLs_rand,.before = clutch)

#run model
# SL_noparent_shuffle <- MCMCglmm(length ~ 1+age, random=~clutch+animal,
#                                 prior=list(R = list(V=V,nu=nu),
#                                            G = list(G1 = list(V=V,nu=nu),
#                                                     G2 = list(V=V,nu=nu))),
#                                 data=phens_rand,nitt=100000,burnin=100,thin=10)

#plot results

#plot(SL_noparent_shuffle)
plot_priorandpost_VA(SL_noparent_shuffle,nu,V)
```

[Note that for this and most of the results presented here, the model convergence isn't terrible, but it also isn't ideal -- that's why you see the bumpy peak above. If I ran the models for longer, I'd expect that peak to even out. But I think we can draw conclusions from the general patterns.]

The result shown in this plot seems like a concern -- the estimate of additive genetic variance here, where there should be none, is larger than any of the estimates we got from using the actual data!

This isn't an artifact; when we reshuffle the SL's among larvae 100 times, we get the following: below is the same prior vs posterior plot from case 1 above (the prior used in the manuscript); the black bar represents the range of estimates of the mode of the posterior distribution of VA from the 100 random trials. None of them had a posterior mode as low as the one we get from the actual data.

```{r,echo=FALSE, warning=FALSE}
nu. = 0.02
V. = 1

#get summary stats to annotate usual prior vs posterior plot
modemin = min(summ_stats[,10])
modemax = max(summ_stats[,10])
modemean = mean(summ_stats[,10])

#usual prior vs posterior plot
model = SL_noparent_oldprior
xlim=0.04
xvals = seq(0,xlim,length.out=nrow(model$VCV))
prior_mode = xvals[which.max(dinvgamma(xvals,shape = nu./2,scale = nu.*V./2))]
animal_samples = as.data.frame(model$VCV)$animal
post_density = density(animal_samples)
post_mode = post_density$x[which.max(post_density$y)]
colors=c('Prior'='blue','Posterior'='red')

g <- ggplot(as.data.frame(model$VCV), aes(x=animal)) + 
  geom_density(aes(color='Posterior'))+
  geom_line(aes(x = seq(0,xlim,length.out=nrow(model$VCV)), 
                y = dinvgamma(xvals,shape = nu./2,scale = nu.*V./2),
                color='Prior'))+
  geom_vline(aes(xintercept = prior_mode, color='Prior'))+
  geom_vline(aes(xintercept = post_mode, color='Posterior'))+
  labs(color='Legend')+
  ylab('density')+
  scale_color_manual(values=colors)+
  ggtitle(paste('V=',V.,' nu=',nu.))+
  annotate('text', x=c(prior_mode,post_mode),y=c(10,20),label=c(as.character(round(prior_mode,4)),as.character(round(post_mode,4))),colour = c('blue','red'))+
  annotate('segment', x=modemin,xend=modemax,y=100,yend=100,color='black',size=1.5)

print(g)
```

So far we've been looking at estimates of VA; it's also worth looking at the estimates of heritability (i.e., VA/total phenotypic variance). I don't have prior distributions for heritability (although I think I could theoretically derive them with some effort), but we can look at the posteriors. Here's the one using the prior from the manuscript:

```{r,echo=FALSE}
model_results(SL_noparent_oldprior)
```


And here are the corresponding posterior estimates for the shuffled data -- that is, the null expectations for the variance components, if lengths were distributed randomly among larvae. (Note that clutch is the top row in this plot instead of the middle row)

```{r,echo=FALSE}
model_results(SL_noparent_shuffle)
```

This pattern is very consistent, no matter which prior is used, etc. Using the shuffled data, clutch is estimated to account for a small proportion of the variance, and the estimates for VA and VE are basically the same. That seems to me to say that, with the study design we have and the data we collected, if there is no underlying relationship between genetic relatedness and SL, the model apportions variance equally between VA and VE.

- This doesn't seem right. I'm not sure yet if it's a limitation of the study design, or if there's some error in the way I'm coding the model, or something else.
- If I haven't made some computational error, then what does it mean that our estimate of VA is actually lower than the null expectation?
