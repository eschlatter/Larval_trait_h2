---
title: "Heritability analysis update"
author: "E Schlatter"
date: "7/19/2022"
output: html_document
---

```{r}
library(tidyverse)
library(MasterBayes) #for pedigree functions
library(MCMCglmm) #for running the model
library(MCMCpack) #for inverse wishart distributions
library(bayesplot) #mcmc_areas plot function
library(gridExtra) #multiple plots per figure

source("../functions/model_fns.R")
load(file='../data/h2data.RData')
```

# Prior and posterior plots

Following the suggestion of one reviewer, I'm looking at a second set of priors. We're estimating three variance components: additive genetic, clutch, and residual. (Or five -- add dam and sire -- in the model with parental effects.)

*Prior 1:* The one I used previously. Priors for all variance components are very flat, all with their modes close to zero.

*Prior 2:* The reviewer suggested trying modes equal to 1/3 (or 1/5) of the total phenotypic variance: i.e., a null hypothesis that all components contribute equally to the phenotypic variance. These priors are still all very flat.

## SL, no parent

### Prior 1: all components close to zero


All components close to 0, parameter expansion.
Animal, clutch, and residual have all moved away from where the prior is centered.
Animal's posterior is bimodal.
```{r}
prior = list(R=list(V=1,nu=0.002),
             G=list(G1=list(V = 1,nu = 1000, alpha.mu=0, alpha.V=1),G2=list(V = 1,nu = 1000, alpha.mu=0, alpha.V=1)))
load(file='../model_runs/SL_noparent_trimdata_10e5.RData')
model = SL_noparent_trimdata_10e5[[1]]

model_diagnostics(model)
model_results(model)
plot_priorandpost_two(model,prior,xlim=0.1)
```
From paper.
```{r}
prior = list(R=list(V=1,nu=0.002),
             G=list(G1=list(V = 1,nu = .02),G2=list(V = 1,nu = .02)))

load(file='../model_runs/SL_noparent_trimdata_10e5.RData')
model = SL_noparent_trimdata_10e5[[4]]

model_diagnostics(model)
model_results(model)
plot_priorandpost_two(model,prior,xlim=0.1)
```

#### **this one
All variances near zero, no parameter expansion
All components have moved away from where the prior is centered.
All posteriors look nice; no bimodality.
Trace doesn't look great; probably needs to run a little longer.
```{r}
prior = list(R=list(V=1,nu=0.002),
             G=list(G1=list(V = 1,nu = .002),G2=list(V = 1,nu = .002)))
load(file='../model_runs/SL_noparent_trimdata_10e5.RData')
model = SL_noparent_trimdata_10e5[[3]]

model_diagnostics(model)
model_results(model)
plot_priorandpost_two(model,prior,xlim=0.1)
```
All variance is residual
Animal and clutch have increased wrt prior, and residual has decreased.
Animal posterior is bimodal.
```{r}
nu = 0.001
p_var = var(phens$length,na.rm=TRUE) #total phenotypic variance
p_A = p_var * 0.01
V_A = ((nu+2)/nu)*p_A
p_C = p_var * 0.01
V_C = ((nu+2)/nu)*p_C
p_E = p_var * 0.98
V_E = ((nu+2)/nu)*p_E

prior = list(R=list(V=V_E,nu=nu),
             G=list(G1=list(V=1,nu=1000,alpha.mu=0,alpha.V=1),G2=list(V=V_C,nu=nu)))
# model <- MCMCglmm(length~1+age,
#                     random=~animal+clutch,
#                     prior=prior, ginverse=list(animal=Ainv),
#                     data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)

load(file='../model_runs/priors_and_posts/SL_noparent_1.RData')

model_diagnostics(model)
model_results(model)
plot_priorandpost_two(model,prior,xlim=0.1)
```

### Prior 2: equal variances
```{r}
nu = 0.001
p_var = var(phens$length,na.rm=TRUE) #total phenotypic variance
p_A = p_var/3 #prior mode for additive genetic effect
V_A = ((nu+2)/nu)*p_A #prior parameter V (inverse Wishart) for additive genetic effect
p_C = p_var/3
V_C = ((nu+2)/nu)*p_C
p_E = p_var/3
V_E = ((nu+2)/nu)*p_E


prior = list(R=list(V=V_E,nu=nu),G=list(G1=list(V=V_A,nu=nu),G2=list(V=V_C,nu=nu)))
model <- MCMCglmm(length~1+age,
                    random=~animal+clutch,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)
save(model,file='../model_runs/priors_and_posts/SL_noparent_2.RData')
```

```{r}
load(file='../model_runs/priors_and_posts/SL_noparent_2.RData')

model_diagnostics(model)
model_results(model)
plot_priorandpost_two(model,prior,xlim=0.1)
```

## SL, with parent

### Prior 1: all variances near zero
#### **this one
All variances near zero, no parameter expansion (same prior as for SL, no parent, with all variances near zero)

```{r}
prior = list(R=list(V=1,nu=0.002),
             G=list(G1=list(V = 1,nu = .002),G2=list(V = 1,nu = .002),G3=list(V = 1,nu = .002),G4=list(V = 1,nu = .002)))
load(file='../model_runs/SL_parent_trimdata_10e5.RData')
model = SL_parent_trimdata_10e5[[3]]

model_diagnostics(model)
model_results(model)
plot_priorandpost_two(model,prior,xlim=0.1)
```

### all variance is residual
VA mixes very poorly without parameter expansion. So we'll add that.
```{r}
nu = 0.001
p_var = var(phens$length,na.rm=TRUE) #total phenotypic variance

p_A = p_var * 0.01
V_A = ((nu+2)/nu)*p_A
V_C = V_A
V_D = V_A
V_S = V_A

p_E = p_var * 0.94
V_E = ((nu+2)/nu)*p_E


prior = list(R=list(V=V_E,nu=nu),
             G=list(G1=list(V=1,nu=1000,alpha.mu=0,alpha.V=1),G2=list(V=V_C,nu=nu),G3=list(V=V_D,nu=nu),G4=list(V=V_S,nu=nu)))
  model <- MCMCglmm(length~1+age,
                    random=~animal+clutch+dam+sire,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)
save(model,file='../model_runs/priors_and_posts/SL_withparent_1.RData')
```

```{r}
load(file='../model_runs/priors_and_posts/SL_withparent_1.RData')

model_diagnostics(model)
model_results(model)
plot_priorandpost_two(model,prior,xlim=0.1)
```

### Prior 2: equal variances

```{r}
nu = 0.001
p_var = var(phens$length,na.rm=TRUE) #total phenotypic variance
p_A = p_var * 0.2
V_A = ((nu+2)/nu)*p_A
V_C = V_A
V_D = V_A
V_S = V_A
V_E = V_A


prior = list(R=list(V=V_E,nu=nu),
             G=list(G1=list(V=V_A,nu=nu),G2=list(V=V_C,nu=nu),G3=list(V=V_D,nu=nu),G4=list(V=V_S,nu=nu)))
  model <- MCMCglmm(length~1+age,
                    random=~animal+clutch+dam+sire,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)
save(model,file='../model_runs/priors_and_posts/SL_withparent_2.RData')
```

## Ucrit, no parent

### Prior 1: all variance is residual
```{r}
nu = 0.001
p_var = var(phens$speed,na.rm=TRUE) #total phenotypic variance
p_A = p_var * 0.01
V_A = ((nu+2)/nu)*p_A
p_C = p_var * 0.01
V_C = ((nu+2)/nu)*p_C
p_E = p_var * 0.98
V_E = ((nu+2)/nu)*p_E

prior = list(R=list(V=V_E,nu=nu),G=list(G1=list(V=V_A,nu=nu),G2=list(V=V_C,nu=nu)))
model <- MCMCglmm(speed~1+age,
                    random=~animal+clutch,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)
save(model,file='../model_runs/priors_and_posts/Ucrit_noparent_1.RData')
```

### Prior 2: equal variances
```{r}
nu = 0.001
p_var = var(phens$speed,na.rm=TRUE) #total phenotypic variance
p_A = p_var/3 #prior mode for additive genetic effect
V_A = ((nu+2)/nu)*p_A #prior parameter V (inverse Wishart) for additive genetic effect
p_C = p_var/3
V_C = ((nu+2)/nu)*p_C
p_E = p_var/3
V_E = ((nu+2)/nu)*p_E


prior = list(R=list(V=V_E,nu=nu),G=list(G1=list(V=V_A,nu=nu),G2=list(V=V_C,nu=nu)))
model <- MCMCglmm(speed~1+age,
                    random=~animal+clutch,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)
save(model,file='../model_runs/priors_and_posts/Ucrit_noparent_2.RData')
```

## Ucrit, with parent

### Prior 1: all variance is residual

```{r}
nu = 0.001
p_var = var(phens$speed,na.rm=TRUE) #total phenotypic variance

p_A = p_var * 0.01
V_A = ((nu+2)/nu)*p_A
V_C = V_A
V_D = V_A
V_S = V_A

p_E = p_var * 0.94
V_E = ((nu+2)/nu)*p_E


prior = list(R=list(V=V_E,nu=nu),
             G=list(G1=list(V=V_A,nu=nu),G2=list(V=V_C,nu=nu),G3=list(V=V_D,nu=nu),G4=list(V=V_S,nu=nu)))
  model <- MCMCglmm(speed~1+age,
                    random=~animal+clutch+dam+sire,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)
save(model,file='../model_runs/priors_and_posts/Ucrit_withparent_1.RData')
```

### Prior 2: equal variances

```{r}
nu = 0.001
p_var = var(phens$speed,na.rm=TRUE) #total phenotypic variance
p_A = p_var * 0.2
V_A = ((nu+2)/nu)*p_A
V_C = V_A
V_D = V_A
V_S = V_A
V_E = V_A

prior = list(R=list(V=V_E,nu=nu),
             G=list(G1=list(V=V_A,nu=nu),G2=list(V=V_C,nu=nu),G3=list(V=V_D,nu=nu),G4=list(V=V_S,nu=nu)))
  model <- MCMCglmm(speed~1+age,
                    random=~animal+clutch+dam+sire,
                    prior=prior, ginverse=list(animal=Ainv),
                    data=phens,nitt=100000,burnin=round(.01*100000),thin=10,verbose=FALSE)
save(model,file='../model_runs/priors_and_posts/Ucrit_withparent_2.RData')
```

